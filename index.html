<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Planning Transport Mensuel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: sans-serif;
        padding: 1vw;
        background-color: #f0f2f5;
        margin: 0;
        width: 100%;
        overflow-x: auto;
      }
      /* Style pour l'√©tat "vide / gris" */
      .placeholder-style {
        color: #a0a0a0 !important;
        -webkit-text-fill-color: #a0a0a0 !important; /* Force pour les navigateurs bas√©s sur Chrome */
        font-size: 13px;
      }

      /* Style pour l'√©tat "saisi / noir" */
      .text-filled {
        color: #000000 !important;
        -webkit-text-fill-color: #000000 !important;
        font-size: 13px;
      }
      .header-tools {
        background: white;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 10px;
        align-items: stretch;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px; /* Un peu plus de confort */
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        flex: 1 0 180px; /* S'√©tire (1), ne r√©tr√©cit pas (0), base de 180px */
        max-width: 100%; /* S√©curit√© pour ne pas d√©border */
      }
      .button-group .btn {
        width: 100%; /* Les boutons prennent toute la largeur du groupe */
        white-space: nowrap; /* √âvite que le texte du bouton revienne √† la ligne */
        font-size: 13px;
        text-align: center;
      }
      .group-title {
        font-size: 0.75rem;
        font-weight: bold;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 3px;
      }
      @media (max-width: 768px) {
        .header-tools {
          display: flex;
          flex-wrap: wrap; /* Permet aux boutons de passer √† la ligne */
          gap: 10px;
          justify-content: center;
        }
        .button-group {
          flex: 1 1 calc(50% - 10px); /* Prend 50% de la largeur moins l'√©cart */
          display: flex;
        }
        .button-group button {
          width: 100%; /* Le bouton s'√©tire dans son groupe */
        }
      }
      @media (max-width: 480px) {
        .header-tools {
          flex-direction: column;
          align-items: stretch;
        }
        .button-group {
          flex: 1 1 100%; /* Prend toute la largeur de l'√©cran */
        }
        .button-group button {
          width: 100%;
          padding: 12px; /* Plus facile √† cliquer sur mobile */
          font-size: 16px;
        }
        .header-tools > div:first-child {
          text-align: center;
          margin-bottom: 15px;
          width: 100%;
        }
      }
      @keyframes clignoter-orange {
        0% {
          background-color: #ffc107;
        } /* Orange normal */
        50% {
          background-color: #ffe082;
        } /* Orange tr√®s clair */
        100% {
          background-color: #ffc107;
        } /* Retour √† l'orange */
      }
      /* Style du message d'alerte */
      #notification-doublon {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #ff9800; /* Orange */
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: none; /* Cach√© par d√©faut */
        font-weight: bold;
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .search-filters {
        position: sticky;
        top: 0;
        z-index: 500;
        background: #f0f2f5;
        padding: 10px 0;
      }
      #my-table thead th {
        position: sticky;
        top: 0; /* Ou 60px si vous avez une barre de menu fixe */
        background-color: #007bff;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      }
      #capture-area {
        background: white;
        padding: 1.5vw;
        border-radius: 8px;
        width: 100%;
      }
      .table-container {
        width: 100%;
        max-height: 75vh; /* Hauteur max pour activer le scroll vertical */
        overflow: auto; /* Active scroll H + V */
        position: relative; /* R√©f√©rence pour le sticky des titres */
        background: white;
        border: 1px solid #ddd;
      }
      table {
        border-collapse: collapse;
        width: 2900px;
        table-layout: fixed;
      }
      th,
      td {
        border: 1px solid #ddd;
        text-align: left;
        vertical-align: top;
        height: 3vw;
        font-size: 13px;
        padding: 0.2vw;
      }
      th {
        background-color: #007bff;
        color: white;
      }
      #display-date {
        margin-top: 0;
        color: #333;
        font-size: 18px;
        margin-bottom: 10px;
      }
      .col-associe {
        width: 5%;
      }
      .col-temps {
        width: 2%;
      }
      .col-chantier {
        width: 10%;
      }
      .col-date {
        width: 4%;
      }
      .col-matos {
        width: 10%;
      }
      .col-client {
        width: 15%;
      }
      .col-telephone {
        width: 6%;
        white-space: normal;
        line-height: 1.2;
      }
      .telephone-wrapper {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .telephone-name {
        font-weight: bold;
        font-size: 12px;
        color: #000;
      }

      .telephone-number {
        font-size: 11px;
        color: #666;
        font-style: italic;
      }
      .col-consigne {
        width: 20%;
      }
      .col-chauffeur {
        width: 7%;
      }
      .col-ncommande {
        width: 5%;
      }
      .col-nchantier {
        width: 5%;
      }
      .col-nbon {
        width: 5%;
      }
      .col-tarif,
      .col-tarif-affrete {
        width: 4%;
      }
      .col-supplement-client,
      .col-supplement-affrete {
        width: 4%;
      }
      .col-IC-client,
      .col-IC-affrete {
        width: 3%;
      }
      .col-commentaire {
        width: 5%;
      }
      .col-actions {
        width: 3%;
      }
      .matos-cell {
        padding: 0 !important;
        vertical-align: middle;
      }
      .combo-input {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        padding: 0.2vw;
        font-size: inherit;
        outline: none;
        vertical-align: middle;
      }
      [contenteditable="true"] {
        width: 100%;
        height: 100%;
        padding: 0.5vw 0.2vw;
        outline: none;
      }
      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        color: white;
      }
      .btn-add {
        background-color: #28a745;
      }
      .btn-reset {
        background-color: #dc3545;
      }
      .btn-copy-img {
        background-color: #6610f2;
      }
      .btn-export {
        background-color: #ff9500;
      }
      .btn-config-client {
        background-color: #6c757d;
      }
      .btn-config-associe {
        background-color: #17a2b8;
      }
      .btn-config-chauffeur {
        background-color: #9b1594;
      }
      .btn-config-telephone {
        background-color: #ff5722;
      }
      .btn-copy-day {
        background-color: #ff00b7;
      }
      .btn-paste-day {
        background-color: #00d69a;
      }
      .color-landais {
        background-color: #00eeff !important;
      }
      .color-allard {
        background-color: #fffb00 !important;
      }
      .color-std {
        background-color: #e27aff !important;
      }
      .save-notif {
        color: #28a745;
        font-weight: bold;
        display: none;
        margin-left: auto;
        font-size: 1vw;
      }
      #config-section-client,
      #config-section-associe,
      #config-section-chauffeur,
      #config-section-telephone {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 1000;
        padding: 0 2vw 2vw 2vw;
        overflow-y: auto;
      }
      .config-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: white;
      }
      .config-table th,
      .config-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
        font-size: 0.9rem;
      }
      .config-table th {
        background: #f2f2f2;
        color: #333;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .client-header,
      .group-header {
        background: #e9ecef;
        vertical-align: middle;
      }
      .del-matos-btn {
        color: #dc3545;
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2em;
      }
      .cell-selected {
        background-color: rgba(0, 123, 255, 0.2) !important;
        border: 2px solid #007bff !important;
      }
      .btn-delete {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 2px 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        transition: background 0.3s;
        margin-top: 5px;
      }
      .dropdown-content {
        position: absolute; /* Le menu "flotte" au dessus du contenu */
        z-index: 1000;
        margin-top: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: max-content;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        background: #f9f9f9;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        min-width: 160px;
        max-width: 260px;
      }

      .button-group {
        position: relative; /* N√©cessaire pour le position: absolute au dessus */
        display: inline-block;
      }
      .save-notif2 {
        position: fixed;
        top: 50%; /* Positionne le haut √† 50% de la hauteur */
        left: 50%; /* Positionne la gauche √† 50% de la largeur */
        transform: translate(-50%, -50%) scale(0);
        background-color: #07cc00;
        color: white;
        padding: 15px 30px;
        border-radius: 30px;
        font-weight: bold;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 0;
        text-align: center;
        white-space: pre-line; /* Permet les retours √† la ligne */
        min-width: fit-content;
        display: block;
        pointer-events: none; /* Emp√™che de cliquer dessus quand elle est invisible */
      }

      .notif-visible {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1); /* Revient √† sa taille normale */
        pointer-events: auto;
      }
      .alerte-flash {
        animation: blink-red 0.5s infinite;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
      }
      @keyframes blink-red {
        0% {
          background-color: #ff0000;
          transform: translate(-50%, -50%) scale(1);
        }
        50% {
          background-color: #b30000;
          transform: translate(-50%, -50%) scale(1.1); /* L√©g√®re pulsation */
        }
        100% {
          background-color: #ff0000;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      /* Conteneur pour mettre les boutons c√¥te √† c√¥te en bas */
      .admin-footer-actions {
        display: flex;
        justify-content: space-between; /* Centre les boutons */
        align-items: center;
        margin-top: 50px; /* Espace apr√®s le tableau */
        padding: 20px;
        border-top: 1px solid #ddd;
        background-color: #f8f9fa;
      }

      /* Style de base pour les boutons de maintenance */
      .btn-maintenance {
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        opacity: 0.6;
      }

      .btn-maintenance:hover {
        opacity: 1;
        background-color: #f8f9fa;
      }

      /* Style sp√©cifique pour le bouton Aide (?) */
      .btn-help-circle {
        background: none;
        border: none;
        color: #a5a5a5;
        font-size: 30px;
        font-weight: bold;
        padding: 0;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.3s;
      }

      .btn-help-circle:hover {
        opacity: 1;
      }

      /* Couleur sp√©cifique pour le bouton r√©parer */
      .btn-repair {
        background-color: #17a2b8;
        color: white;
        border: none;
      }
      .footer-left-group {
        display: flex;
        gap: 15px; /* Espace entre "Don't touch me" et "R√©parer" */
      }
    </style>
  </head>
  <body>
    <div id="notification-doublon"></div>
    <datalist id="list-associe"></datalist>
    <datalist id="list-vehicule"></datalist>
    <datalist id="list-client"></datalist>
    <datalist id="list-chauffeur"></datalist>
    <datalist id="list-telephone"></datalist>

    <div class="header-tools">
      <div
        class="button-group"
        onmouseleave="
          document.getElementById('sous-menu-add').style.display = 'none'
        "
      >
        <button
          onmouseenter="toggleMenu('sous-menu-add', event)"
          class="btn"
          style="
            background-color: #ff0000;
            color: rgb(0, 0, 0);
            font-weight: bold;
            font-size: 15px;
          "
        >
          ‚ûï Lignes ‚ñº
        </button>
        <div id="sous-menu-add" class="dropdown-content" style="display: none">
          <button
            id="add-row"
            class="btn btn-add"
            style="width: 100%; margin-bottom: 5px"
          >
            Ajouter une ligne
          </button>
          <button id="reset-day" class="btn btn-reset" style="width: 100%">
            Tout supprimer
          </button>
        </div>
      </div>

      <div
        class="button-group"
        onmouseleave="
          document.getElementById('sous-menu-copy').style.display = 'none'
        "
      >
        <button
          onmouseenter="toggleMenu('sous-menu-copy', event)"
          class="btn"
          style="
            background-color: #ff0000;
            color: rgb(0, 0, 0);
            font-weight: bold;
            font-size: 15px;
          "
        >
          üìã Copier ‚ñº
        </button>
        <div id="sous-menu-copy" class="dropdown-content" style="display: none">
          <button
            id="copy-day"
            class="btn btn-copy-day"
            style="width: 100%; margin-bottom: 5px"
          >
            Copier journ√©e
          </button>
          <button id="paste-day" class="btn btn-paste-day" style="width: 100%">
            Coller journ√©e
          </button>
        </div>
      </div>

      <div
        class="button-group"
        onmouseleave="
          document.getElementById('sous-menu-photos').style.display = 'none'
        "
      >
        <button
          onmouseenter="toggleMenu('sous-menu-photos', event)"
          class="btn"
          style="
            background-color: #ff0000;
            color: rgb(0, 0, 0);
            font-weight: bold;
            font-size: 15px;
          "
        >
          üì§ Export ‚ñº
        </button>
        <div
          id="sous-menu-photos"
          class="dropdown-content"
          style="display: none"
        >
          <button
            id="copy-image"
            class="btn btn-copy-img"
            style="width: 100%; margin-bottom: 5px"
          >
            Copier Image
          </button>
          <button
            id="copy-image-client"
            class="btn"
            style="background-color: #07cc00; width: 100%; margin-bottom: 5px"
          >
            Planning Gueno
          </button>
          <button
            id="export-excel"
            class="btn btn-export"
            style="width: 100%; margin-bottom: 5px"
          >
            Excel
          </button>
          <button
            onclick="imprimerPlanning()"
            class="btn"
            style="background-color: #333; width: 100%"
          >
            üñ®Ô∏è Imprimer
          </button>
        </div>
      </div>

      <div
        class="button-group"
        onmouseleave="
          document.getElementById('sous-menu-config').style.display = 'none'
        "
      >
        <button
          onmouseenter="toggleMenu('sous-menu-config', event)"
          class="btn"
          style="
            background-color: #ff0000;
            color: rgb(0, 0, 0);
            font-weight: bold;
            font-size: 15px;
          "
        >
          ‚öôÔ∏è Configs ‚ñº
        </button>
        <div
          id="sous-menu-config"
          class="dropdown-content"
          style="display: none"
        >
          <button
            id="toggle-config-client"
            class="btn btn-config-client"
            style="width: 100%; margin-bottom: 5px"
          >
            Clients
          </button>
          <button
            id="toggle-config-associe"
            class="btn btn-config-associe"
            style="width: 100%; margin-bottom: 5px"
          >
            Associ√©s
          </button>
          <button
            id="toggle-config-chauffeur"
            class="btn btn-config-chauffeur"
            style="width: 100%; margin-bottom: 5px"
          >
            Chauffeurs
          </button>
          <button
            id="toggle-config-telephone"
            class="btn btn-config-telephone"
            style="width: 100%"
          >
            T√©l√©phones
          </button>
        </div>
      </div>

      <span id="save-notif" class="save-notif"></span>
      <span id="save-notif2" class="save-notif2"></span>
    </div>

    <div id="config-section-client">
      <button
        class="btn btn-reset"
        style="float: right; margin-top: 20px"
        onclick="closeConfigs('config-section-client')"
      >
        Fermer
      </button>
      <h2 style="margin-top: 20px; padding-top: 10px">Configuration Clients</h2>

      <div
        style="
          background: #e9ecef;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <div>
          <strong>Nouveau Groupe :</strong><br />
          <input type="text" id="new-group-name" placeholder="Nom..." />
          <button onclick="addNewGroup()" class="btn btn-add">
            Cr√©er Groupe
          </button>
        </div>
        <div>
          <strong>Nouveau Client :</strong><br />
          <input type="text" id="new-client-name" placeholder="Nom..." />
          <button onclick="addNewClient()" class="btn btn-add">
            Cr√©er Client
          </button>
        </div>
        <div style="border-left: 2px solid #ccc; padding-left: 15px"></div>
        <div>
          <strong>Nouvelle Cat√©gorie :</strong><br />
          <input
            type="text"
            id="global-categorie-client"
            placeholder="Nom..."
          />
          <button
            onclick="addCategorie('client')"
            class="btn btn-config-client"
          >
            Ajouter partout
          </button>
        </div>
        <div>
          <strong>Nouveau Mat√©riel :</strong><br />
          <input type="text" id="global-matos-client" placeholder="Nom..." />
          <button
            onclick="addGlobalMatos('client')"
            class="btn btn-config-client"
          >
            Ajouter partout
          </button>
        </div>
      </div>
      <div id="config-container"></div>
    </div>

    <div id="config-section-associe">
      <button
        class="btn btn-reset"
        style="float: right; margin-top: 20px"
        onclick="closeConfigs('config-section-associe')"
      >
        Fermer
      </button>
      <h2 style="margin-top: 20px; padding-top: 10px">
        Configuration Associ√©s - Affr√©t√©s
      </h2>

      <div
        style="
          background: #e9ecef;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <div>
          <strong>Nouvel Affr√©t√© :</strong><br />
          <input type="text" id="new-config2-name" placeholder="Nom..." />
          <button onclick="addNewClient2()" class="btn btn-add">
            Cr√©er Affr√©t√©
          </button>
        </div>
        <div style="border-left: 2px solid #ccc; padding-left: 15px"></div>
        <div>
          <strong>Nouvelle Cat√©gorie :</strong><br />
          <input
            type="text"
            id="global-categorie-associe"
            placeholder="Nom..."
          />
          <button
            onclick="addCategorie('associe')"
            class="btn btn-config-client"
          >
            Ajouter partout
          </button>
        </div>
        <div>
          <strong>Nouveau Mat√©riel :</strong><br />
          <input type="text" id="global-matos-associe" placeholder="Nom..." />
          <button
            onclick="addGlobalMatos('associe')"
            class="btn btn-config-associe"
          >
            Ajouter partout
          </button>
        </div>
      </div>
      <div id="config-container-2"></div>
    </div>

    <div id="config-section-chauffeur">
      <button
        class="btn btn-reset"
        style="float: right; margin-top: 20px"
        onclick="closeConfigs('config-section-chauffeur')"
      >
        Fermer
      </button>
      <h2 style="margin-top: 20px; padding-top: 10px">
        Configuration Chauffeurs
      </h2>

      <div
        style="
          background: #e9ecef;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: flex;
          gap: 10px;
        "
      >
        <div>
          <strong>Nouveau chauffeur :</strong><br />
          <input
            type="text"
            id="new-config-chauffeur-name"
            placeholder="Nom..."
          />
          <button onclick="addNewChauffeur()" class="btn btn-add">
            Cr√©er Chauffeur
          </button>
        </div>
      </div>
      <div id="config-container-chauffeur"></div>
    </div>

    <div id="config-section-telephone">
      <button
        class="btn btn-reset"
        style="float: right; margin-top: 20px"
        onclick="closeConfigs('config-section-telephone')"
      >
        Fermer
      </button>

      <h2 style="margin-top: 20px; padding-top: 10px">
        Configuration T√©l√©phones Clients
      </h2>

      <div
        style="
          background: #e9ecef;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: flex;
          gap: 10px;
        "
      >
        <div>
          <strong>Nouveau contact :</strong><br />
          <input
            type="text"
            id="new-config-telephone-client"
            placeholder="Nom Client..."
          />
          <input
            type="text"
            id="new-config-telephone-name"
            placeholder="Nom Contact..."
          />
          <input
            type="text"
            id="new-config-telephone-number"
            placeholder="06 00 00..."
          />
          <button onclick="addNewTelephone()" class="btn btn-add">Cr√©er</button>
        </div>
      </div>
      <div id="config-container-telephone"></div>
    </div>

    <div
      class="search-filters"
      style="
        margin-bottom: 15px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        display: flex; /* Active le mode Flexbox */
        align-items: center; /* Aligne verticalement au centre */
        flex-wrap: wrap; /* Permet de revenir √† la ligne sur petit √©cran */
        gap: 10px; /* Espace entre les √©l√©ments */
      "
    >
      <strong style="margin-right: 10px">Filtres :</strong>

      <input
        type="text"
        id="filter-associe"
        placeholder="Filtrer par Associ√©..."
        oninput="filterTable()"
        style="
          padding: 5px;
          margin-right: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
        "
      />

      <input
        type="text"
        id="filter-client"
        placeholder="Filtrer par Client..."
        oninput="filterTable()"
        style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
      />

      <input
        type="text"
        id="filter-chantier"
        placeholder="Filtrer par Chantier..."
        oninput="filterTable()"
        style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
      />

      <input
        type="text"
        id="filter-materiel"
        placeholder="Filtrer par Mat√©riel..."
        oninput="filterTable()"
        style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
      />

      <button
        onclick="resetFilters()"
        style="
          margin-left: 10px;
          padding: 5px 10px;
          cursor: pointer;
          border-radius: 4px;
          border: 1px solid #ccc;
        "
      >
        R√©initialiser
      </button>

      <div style="flex-grow: 1"></div>

      <div>
        Le :
        <input
          type="date"
          id="current-date-picker"
          onchange="updateAllAfterDateChange()"
          style="padding: 3px; border-radius: 4px; border: 1px solid #ccc"
        />
      </div>
    </div>

    <div id="capture-area">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between; /* Titre √† gauche, boutons √† droite */
          gap: 10px;
          margin-bottom: 1vw;
          flex-wrap: wrap; /* √âvite les bugs sur mobile */
        "
      >
        <h2 id="display-date" style="margin: 0">Planning du ...</h2>

        <div
          id="color-picker-tools"
          class="hide-export"
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            background: #fff;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
          "
        >
          <small style="color: #666; font-weight: bold; margin-right: 5px"
            >MARQUER :</small
          >
          <div
            onclick="setColorToSelectedRow('#ffffff')"
            style="
              width: 20px;
              height: 20px;
              background: #fff;
              border: 1px solid #ccc;
              cursor: pointer;
              border-radius: 3px;
            "
            title="Effacer"
          ></div>
          <div
            onclick="setColorToSelectedRow('#ffee00')"
            style="
              width: 20px;
              height: 20px;
              background: #ffee00;
              cursor: pointer;
              border-radius: 3px;
            "
            title="Prise de commande"
          ></div>
          <div
            onclick="setColorToSelectedRow('#ffae00')"
            style="
              width: 20px;
              height: 20px;
              background: #ffae00;
              cursor: pointer;
              border-radius: 3px;
            "
            title="R√©duction"
          ></div>
          <div
            onclick="setColorToSelectedRow('#ff0000')"
            style="
              width: 20px;
              height: 20px;
              background: #ff0000;
              cursor: pointer;
              border-radius: 3px;
            "
            title="Intemp√©ries"
          ></div>
          <div
            onclick="setColorToSelectedRow('#b700ff')"
            style="
              width: 20px;
              height: 20px;
              background: #b700ff;
              cursor: pointer;
              border-radius: 3px;
            "
            title="Violet"
          ></div>
          <div
            onclick="setColorToSelectedRow('#ff00d4')"
            style="
              width: 20px;
              height: 20px;
              background: #ff00d4;
              cursor: pointer;
              border-radius: 3px;
            "
            title="Rose"
          ></div>
        </div>
      </div>
      <div class="table-container">
        <table id="my-table">
          <thead>
            <tr>
              <th class="col-associe">Associ√©</th>
              <th class="col-temps">Matin</th>
              <th class="col-temps">A-M</th>
              <th class="col-chantier">Chantier</th>
              <th class="col-date">Date</th>
              <th class="col-matos">Mat√©riel</th>
              <th class="col-client">Client</th>
              <th class="col-telephone">Contact Client</th>
              <th class="col-consigne">Consigne</th>
              <th class="col-chauffeur">Chauffeur</th>
              <th class="col-ncommande">N¬∞ Commande</th>
              <th class="col-nchantier">N¬∞ Chantier</th>
              <th class="col-nbon">N¬∞ Bon</th>
              <th class="col-tarif hide-export">Tarif-client</th>
              <th class="col-supplement-client hide-export">
                Suppl√©ment-client
              </th>
              <th class="col-IC-client hide-export">IC-client</th>
              <th class="col-tarif-affrete hide-export">Tarif-affr√©t√©</th>
              <th class="col-supplement-affrete hide-export">
                Suppl√©ment-affr√©t√©
              </th>
              <th class="col-IC-affrete hide-export">IC-affr√©t√©</th>
              <th class="col-commentaire hide-export">Commentaire</th>
              <th class="col-actions hide-export">Actions</th>
            </tr>
          </thead>

          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>

    <div id="totals-container" class="hide-export">
      <table style="width: 100%; border-collapse: collapse; margin-top: 10px">
        <tfoot>
          <tr
            style="
              background: #f8f9fa;
              font-weight: bold;
              border: 1px solid #ccc;
            "
          >
            <td style="padding: 10px">
              <div
                style="
                  display: flex;
                  flex-wrap: nowrap;
                  justify-content: space-between; /* Utilise tout l'espace disponible */
                  align-items: left;
                  gap: 30px;
                  width: 100%;
                  overflow: hidden;
                  font-size: clamp(0.4rem, 1vw, 0.7rem);
                "
              >
                <div style="flex: 1; text-align: left; line-height: 1.4">
                  <strong
                    style="color: #007bff; font-size: 1.2em; display: block"
                    >SECTION CLIENT</strong
                  >
                  <div style="white-space: nowrap; margin-top: 5px">
                    TARIF :
                    <span id="total-price" style="color: #007bff">0.00 ‚Ç¨</span>
                    SUPPLEMENT :
                    <span
                      id="total-price-supplement-client"
                      style="color: #007bff"
                      >0.00 ‚Ç¨</span
                    >
                    IC :
                    <span id="total-price-IC-client" style="color: #007bff"
                      >0.00 ‚Ç¨</span
                    >
                  </div>
                  <div style="font-size: 1em">
                    TOTAL GENERAL :
                    <span id="total-marge-client" style="color: #007bff"
                      >0.00 ‚Ç¨</span
                    >
                  </div>
                </div>

                <div style="flex: 1; text-align: left; line-height: 1.4">
                  <strong
                    style="color: #dc3545; font-size: 1.2em; display: block"
                    >SECTION AFFR√âT√â</strong
                  >
                  <div style="white-space: nowrap; margin-top: 5px">
                    TARIF :
                    <span id="total-price-affrete" style="color: #dc3545"
                      >0.00 ‚Ç¨</span
                    >
                    SUPPLEMENT :
                    <span
                      id="total-price-supplement-affrete"
                      style="color: #dc3545"
                      >0.00 ‚Ç¨</span
                    >
                    IC :
                    <span id="total-price-IC-affrete" style="color: #dc3545"
                      >0.00 ‚Ç¨</span
                    >
                  </div>
                  <div style="font-size: 1em">
                    TOTAL GENERAL :
                    <span id="total-marge-affrete" style="color: #dc3545"
                      >0.00 ‚Ç¨</span
                    >
                  </div>
                </div>

                <div style="flex: 1; text-align: left; line-height: 1.4">
                  <strong
                    style="color: #000000; font-size: 1.2em; display: block"
                    >R√âSULTAT DU JOUR</strong
                  >
                  <div
                    style="
                      font-size: 1.1em;
                      white-space: nowrap;
                      margin-top: 5px;
                    "
                  >
                    MARGE NETTE :
                    <span id="marge-nette" style="color: #28a745">0.00 ‚Ç¨</span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    <script>
      const defaultMatosList = [
        "6x4",
        "8x4",
        "6x2 GRUE",
        "AC3",
        "PB",
        "PC",
        "8x2 AMP GRUE",
      ];

      const defaultChauffeursList = [];

      let isMouseDown = false;

      function toggleHelp() {
        const modal = document.getElementById("help-modal");
        const overlay = document.getElementById("help-overlay");
        const isVisible = modal.style.display === "block";

        modal.style.display = isVisible ? "none" : "block";
        overlay.style.display = isVisible ? "none" : "block";
      }

      function toggleMenu(id, event) {
        if (event) event.stopPropagation();

        const menus = [
          "sous-menu-add",
          "sous-menu-copy",
          "sous-menu-photos",
          "sous-menu-config",
        ];

        menus.forEach((menuId) => {
          const el = document.getElementById(menuId);
          if (menuId === id) {
            el.style.display =
              el.style.display === "none" || el.style.display === ""
                ? "block"
                : "none";
          } else {
            el.style.display = "none";
          }
        });
      }

      window.onclick = function (event) {
        if (!event.target.matches(".btn")) {
          const menus = [
            "sous-menu-add",
            "sous-menu-copy",
            "sous-menu-photos",
            "sous-menu-config",
          ];

          menus.forEach((menuId) => {
            const el = document.getElementById(menuId);
            if (el) el.style.display = "none";
          });
        }
      };

      function updateAllAfterDateChange() {
        // 1. On redessine les tableaux de configuration pour afficher les indices du bon mois
        renderConfigUI();

        // 2. Si vous avez un deuxi√®me tableau (Associ√©s/Affr√©t√©s)
        if (typeof renderConfigUI2 === "function") {
          renderConfigUI2();
        }

        // 3. On recalcule les tarifs dans le planning principal (le grand tableau)
        if (typeof refreshAllPlanningTarifs === "function") {
          refreshAllPlanningTarifs();
        } else if (typeof renderPlanning === "function") {
          renderPlanning();
        }
      }

      function imprimerPlanning() {
        // 1. Extraire toutes les donn√©es des lignes
        const lignes = [];
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          lignes.push({
            associe: tr.querySelector(".select-associe")?.value || "",
            matin: tr.cells[1]?.innerText || "",
            apres: tr.cells[2]?.innerText || "",
            chantier: tr.cells[3]?.innerText || "",
            date: tr.cells[4]?.innerText || "",
            vehicule: tr.querySelector(".select-vehicule")?.value || "",
            client: tr.querySelector(".select-client")?.value || "",
            telephone: tr.querySelector(".select-telephone")?.value || "",
            consigne: tr.cells[8]?.innerText || "",
            chauffeur: tr.querySelector(".select-chauffeur")?.value || "",
            n_commande: tr.cells[10]?.innerText || "",
            n_chantier: tr.cells[11]?.innerText || "",
            n_bon: tr.cells[12]?.innerText || "",
            couleur: tr.style.backgroundColor || "",
          });
        });

        // 2. R√©cup√©rer le titre
        const titre = document.getElementById("display-date").innerText;

        // 3. Cr√©er la fen√™tre d'impression
        const fenetreImpression = window.open("", "", "height=600,width=800");

        // 4. Injecter les styles
        fenetreImpression.document.write(`
              <html>
              <head>
                <title>Impression Planning</title>
                <style>
                  body { font-family: sans-serif; margin: 20px; }
                  h2 { text-align: center; }
                  table {
                    border-collapse: collapse;
                    width: 100%;
                    font-size: 11px;
                  }
                  th, td {
                    border: 1px solid #ddd;
                    padding: 6px;
                    text-align: left;
                  }
                  th {
                    background-color: #007bff !important;
                    color: white !important;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                  }
                  @media print {
                    th {
                      background-color: #007bff !important;
                      color: white !important;
                    }
                  }
                </style>
              </head>
              <body>
                <h2>${titre}</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Associ√©</th>
                      <th>Matin</th>
                      <th>A-M</th>
                      <th>Chantier</th>
                      <th>V√©hicule</th>
                      <th>Client</th>
                      <th>Contact</th>
                      <th>Consigne</th>
                      <th>Chauffeur</th>
                      <th>N¬∞ Commande</th>
                      <th>N¬∞ Chantier</th>
                      <th>N¬∞ Bon</th>
                    </tr>
                  </thead>
                  <tbody>
            `);

        // 5. G√©n√©rer les lignes avec les donn√©es extraites
        lignes.forEach((ligne) => {
          const bgColor = ligne.couleur
            ? ` style="background-color: ${ligne.couleur}; -webkit-print-color-adjust: exact; print-color-adjust: exact;"`
            : "";

          fenetreImpression.document.write(`
                <tr${bgColor}>
                  <td>${ligne.associe}</td>
                  <td>${ligne.matin}</td>
                  <td>${ligne.apres}</td>
                  <td>${ligne.chantier}</td>
                  <td>${ligne.vehicule}</td>
                  <td>${ligne.client}</td>
                  <td>${ligne.telephone}</td>
                  <td>${ligne.consigne}</td>
                  <td>${ligne.chauffeur}</td>
                  <td>${ligne.n_commande}</td>
                  <td>${ligne.n_chantier}</td>
                  <td>${ligne.n_bon}</td>
                </tr>
              `);
        });

        fenetreImpression.document.write(`
                  </tbody>
                </table>
              </body>
              </html>
            `);

        fenetreImpression.document.close();

        // 6. Lancer l'impression apr√®s chargement
        setTimeout(() => {
          fenetreImpression.print();
          fenetreImpression.close();
        }, 500);
      }

      function resetTout() {
        const premiereConfirmation = confirm(
          "ATTENTION : Vous allez vider TOUTE la m√©moire du site. Continuer ?",
        );

        if (premiereConfirmation) {
          const codeSecret = "9051";
          const saisieUtilisateur = prompt(
            "Entrez le mot de passe pour confirmer :",
          );
          const notif = document.getElementById("save-notif2");

          if (saisieUtilisateur === codeSecret) {
            localStorage.clear();
            location.reload();
          } else if (saisieUtilisateur !== null) {
            // Configuration de l'alerte
            // Remplace .textContent par .innerText
            notif.innerText = `‚ö†Ô∏è CODE INCORRECT ‚ö†Ô∏è
                                VOUS N'√äTES PAS AUTORIS√â √Ä EFFECTUER CETTE ACTION !`;
            notif.classList.add("alerte-flash", "notif-visible");

            // Disparition apr√®s 4 secondes
            setTimeout(() => {
              notif.classList.remove("notif-visible");

              // On attend la fin de l'animation de remont√©e pour reset les couleurs
              setTimeout(() => {
                notif.classList.remove("alerte-flash");
                notif.textContent = "OK"; // Reset texte
              }, 500);
            }, 5500);
          }
        }
      }

      function afficherNotification(message, couleur = "#ff9800") {
        const notif = document.getElementById("notification-doublon");

        if (!notif) {
          console.warn(
            "L'√©l√©ment #notification-doublon est absent du HTML. Message : " +
              message,
          );
          return;
        }

        notif.textContent = message;
        notif.style.backgroundColor = couleur;
        notif.style.display = "block";

        setTimeout(() => {
          notif.style.display = "none";
        }, 3000);
      }

      let startRowIndex = null;

      document
        .getElementById("my-table")
        .addEventListener("mousedown", function (e) {
          const td = e.target.closest("td");
          if (!td) return;

          // ‚úÖ IGNORER LE CLIC DROIT (button === 2)
          if (e.button === 2) return;

          isMouseDown = true;
          startRowIndex = td.parentElement.rowIndex;

          if (!e.ctrlKey) {
            document
              .querySelectorAll(".cell-selected")
              .forEach((el) => el.classList.remove("cell-selected"));
          }
          td.classList.add("cell-selected");
        });

      document
        .getElementById("my-table")
        .addEventListener("mouseover", function (e) {
          if (isMouseDown) {
            const td = e.target.closest("td");
            if (td && td.parentElement.rowIndex === startRowIndex) {
              td.classList.add("cell-selected");
            }
          }
        });

      window.addEventListener("mouseup", () => {
        isMouseDown = false;
        startRowIndex = null;
      });

      document.addEventListener("click", function (e) {
        // ‚úÖ NE PAS d√©s√©lectionner si c'est un clic droit (contextmenu)
        if (e.button === 2) return;

        if (!e.target.closest("#my-table")) {
          document
            .querySelectorAll(".cell-selected")
            .forEach((el) => el.classList.remove("cell-selected"));
        }
      });

      document
        .getElementById("my-table")
        .addEventListener("contextmenu", function (e) {
          const td = e.target.closest("td");

          // Si on clique sur une cellule NON s√©lectionn√©e, on la s√©lectionne d'abord
          if (td && !td.classList.contains("cell-selected")) {
            document
              .querySelectorAll(".cell-selected")
              .forEach((el) => el.classList.remove("cell-selected"));
            td.classList.add("cell-selected");
          }

          // ‚úÖ NOUVEAU : Cr√©er une vraie s√©lection de texte pour le navigateur
          if (td) {
            const selection = window.getSelection();
            const range = document.createRange();

            const input = td.querySelector("input");

            try {
              if (input) {
                // ‚úÖ CAS INPUT : On s√©lectionne la VALUE de l'input
                input.select(); // M√©thode native pour s√©lectionner le texte d'un input
                input.focus();
              } else {
                // ‚úÖ CAS TEXTE : On s√©lectionne le contenu de la cellule
                range.selectNodeContents(td);
                selection.removeAllRanges();
                selection.addRange(range);
              }
            } catch (err) {
              // Ignorer les erreurs si la cellule est vide
            }
          }

          // Le navigateur affichera automatiquement son menu "Copier"
        });

      document.addEventListener("copy", function (e) {
        const selectedCells = document.querySelectorAll(".cell-selected");

        // ‚úÖ Si aucune cellule s√©lectionn√©e, laisser le comportement natif
        if (selectedCells.length === 0) {
          return;
        }

        let rows = {};

        // 1. Tri pour respecter l'ordre d'affichage
        const sortedCells = Array.from(selectedCells).sort((a, b) => {
          if (a.parentElement.rowIndex !== b.parentElement.rowIndex) {
            return a.parentElement.rowIndex - b.parentElement.rowIndex;
          }
          return a.cellIndex - b.cellIndex;
        });

        // 2. Traitement avec ajout des libell√©s
        sortedCells.forEach((td) => {
          const rowIndex = td.parentElement.rowIndex;
          if (!rows[rowIndex]) rows[rowIndex] = [];

          const input = td.querySelector("input");
          let val = input ? input.value.trim() : td.innerText.trim();

          // Liste des placeholders √† ne pas copier
          const placeholders = [
            "Chantier...",
            "V√©hicule...",
            "Client...",
            "Contact...",
            "Consigne...",
            "Chauffeur...",
            "N¬∞ Commande...",
            "N¬∞ Chantier...",
            "N¬∞ Bon...",
            "Commentaire...",
          ];

          if (placeholders.includes(val)) {
            val = "";
          }

          if (val !== "") {
            // Ajout des pr√©fixes selon le type de cellule
            if (input) {
              if (input.classList.contains("select-vehicule")) {
                val = "V√©hicule : " + val;
              } else if (input.classList.contains("select-client")) {
                val = "Client : " + val;
              } else if (input.classList.contains("select-telephone")) {
                val = "Contact : " + val;
              } else if (input.classList.contains("select-chauffeur")) {
                val = "Chauffeur : " + val;
              }
            } else {
              const cellIndex = td.cellIndex;

              if (td.classList.contains("col-consigne")) {
                val = "Consigne : " + val;
              } else if (cellIndex === 10) {
                val = "N¬∞ Commande : " + val;
              } else if (cellIndex === 11) {
                val = "N¬∞ Chantier : " + val;
              } else if (cellIndex === 12) {
                val = "N¬∞ Bon : " + val;
              }
            }
          }

          rows[rowIndex].push(val);
        });

        // 3. Construction du texte final
        const textResult = Object.values(rows)
          .map((rowCells) => rowCells.filter((c) => c !== "").join(" "))
          .join("\n");

        if (textResult) {
          e.clipboardData.setData("text/plain", textResult);
          e.preventDefault();

          afficherNotification(
            `${selectedCells.length} cellule(s) copi√©e(s) !`,
            "#4caf50",
          );
        }
      });

      let transportConfigClient =
        JSON.parse(localStorage.getItem("transport_config_client")) || {};
      let transportConfigAssocie =
        JSON.parse(localStorage.getItem("transport_config_associe")) || {};
      let transportConfigChauffeur =
        JSON.parse(localStorage.getItem("transport_config_chauffeur")) || {};
      let transportConfigTelephone =
        JSON.parse(localStorage.getItem("transport_config_telephone")) || {};
      let transportConfigGroup =
        JSON.parse(localStorage.getItem("transport_config_group")) || {};
      let transportConfigMateriel =
        JSON.parse(localStorage.getItem("transport_config_materiel")) || {};
      let transportConfigCategorie =
        JSON.parse(localStorage.getItem("transport_config_categorie")) || {};
      let transportConfigGroupCat =
        JSON.parse(localStorage.getItem("transportConfigGroupCat")) || {};
      let transportConfigGroupInfo =
        JSON.parse(localStorage.getItem("transportConfigGroupInfo")) || {};

      function setColorToSelectedRow(color) {
        const rows = document.querySelectorAll(
          "tr:has(.cell-selected), .row-marked",
        );

        const currentDate = document.getElementById(
          "current-date-picker",
        ).value;
        const allSavedColors = JSON.parse(
          localStorage.getItem("planningColors") || "{}",
        );

        if (!allSavedColors[currentDate]) {
          allSavedColors[currentDate] = {};
        }

        const savedColors = allSavedColors[currentDate];

        if (rows.length === 0) {
          alert(
            "Veuillez d'abord s√©lectionner au moins une cellule ou une ligne.",
          );
          return;
        }

        rows.forEach((row) => {
          const rowId = row.innerText.trim().split("\t")[0] + row.rowIndex;
          const cells = row.querySelectorAll("td");

          if (color === "#ffee00") {
            // --- CAS DU JAUNE : Uniquement les cellules s√©lectionn√©es ---
            const selectedCellsInRow = row.querySelectorAll(".cell-selected");

            if (!savedColors[rowId] || typeof savedColors[rowId] !== "object") {
              savedColors[rowId] = { type: "partial", cells: {} };
            }

            selectedCellsInRow.forEach((td) => {
              const cellIndex = td.cellIndex;
              td.style.backgroundColor = color;
              savedColors[rowId].cells[cellIndex] = color;
            });
          } else if (color === "#ffffff") {
            // --- CAS DU BLANC : Comportement selon le type de marquage existant ---

            const existingData = savedColors[rowId];

            if (
              existingData &&
              typeof existingData === "object" &&
              existingData.type === "partial"
            ) {
              // ‚úÖ Si c'√©tait un marquage JAUNE (partiel) ‚Üí Effacer cellule par cellule
              const selectedCellsInRow = row.querySelectorAll(".cell-selected");

              selectedCellsInRow.forEach((td) => {
                const cellIndex = td.cellIndex;
                td.style.backgroundColor = "";
                delete savedColors[rowId].cells[cellIndex];
              });

              // Si plus aucune cellule marqu√©e, supprimer l'entr√©e
              if (Object.keys(savedColors[rowId].cells).length === 0) {
                delete savedColors[rowId];
              }
            } else {
              // ‚úÖ Si c'√©tait une couleur PLEINE LIGNE ‚Üí Effacer toute la ligne
              cells.forEach((td, index) => {
                const hasSpecificColor =
                  td.style.backgroundColor !== "" &&
                  td.style.backgroundColor !== "transparent";
                if (index === 0 && hasSpecificColor) return; // Pr√©server la couleur de l'associ√©
                td.style.backgroundColor = "";
              });

              delete savedColors[rowId];
            }
          } else {
            // --- AUTRES COULEURS : Toute la ligne ---
            cells.forEach((td, index) => {
              const hasSpecificColor =
                td.style.backgroundColor !== "" &&
                td.style.backgroundColor !== "transparent";
              if (index === 0 && hasSpecificColor) return;
              td.style.backgroundColor = color;
            });

            savedColors[rowId] = color;
          }
        });

        localStorage.setItem("planningColors", JSON.stringify(allSavedColors));
      }

      function filterTable() {
        const associeQuery = document
          .getElementById("filter-associe")
          .value.toUpperCase();
        const clientQuery = document
          .getElementById("filter-client")
          .value.toUpperCase();
        const chantierQuery = document
          .getElementById("filter-chantier")
          .value.toUpperCase();
        const materielQuery = document
          .getElementById("filter-materiel")
          .value.toUpperCase();
        const rows = document.querySelectorAll("#table-body tr");

        rows.forEach((tr) => {
          const associeVal = tr.querySelector(".select-associe")
            ? tr.querySelector(".select-associe").value.toUpperCase()
            : "";
          const clientVal = tr.querySelector(".select-client")
            ? tr.querySelector(".select-client").value.toUpperCase()
            : "";
          const materielVal = tr.querySelector(".select-vehicule")
            ? tr.querySelector(".select-vehicule").value.toUpperCase()
            : "";
          const chantierCell = tr.cells[3];
          let chantierVal = chantierCell
            ? chantierCell.textContent.toUpperCase()
            : "";

          if (chantierVal === "CHANTIER...") chantierVal = "";

          const matchesAssocie = associeVal.includes(associeQuery);
          const matchesClient = clientVal.includes(clientQuery);
          const matchesChantier = chantierVal.includes(chantierQuery);
          const matchesMateriel = materielVal.includes(materielQuery);

          if (
            matchesAssocie &&
            matchesClient &&
            matchesChantier &&
            matchesMateriel
          ) {
            tr.style.display = "";
          } else {
            tr.style.display = "none";
          }
        });
      }

      function resetFilters() {
        document.getElementById("filter-associe").value = "";
        document.getElementById("filter-client").value = "";
        document.getElementById("filter-chantier").value = "";
        document.getElementById("filter-materiel").value = "";
        filterTable();
      }

      function trierDatalist(id) {
        const list = document.getElementById(id);
        if (!list) return;

        const options = Array.from(list.options);
        const baseAssocies = ["ALLARD", "LANDAIS", "STD"];

        options.sort((a, b) => {
          const valA = a.value.toUpperCase();
          const valB = b.value.toUpperCase();

          if (id === "list-associe") {
            const isABase = baseAssocies.includes(valA);
            const isBBase = baseAssocies.includes(valB);

            if (isABase && !isBBase) return -1; // a est prioritaire, il monte
            if (!isABase && isBBase) return 1; // b est prioritaire, il monte
          }

          return valA.localeCompare(valB);
        });

        list.innerHTML = "";
        options.forEach((opt) => list.appendChild(opt));
      }

      function closeConfigs(id) {
        document.getElementById(id).style.display = "none";
      }

      function getTarifClient(clientNom, matosNom) {
        const groupeNom = transportConfigClient[clientNom];
        if (!groupeNom) return 0;

        const groupeData = transportConfigGroup[groupeNom];
        if (groupeData && groupeData[matosNom]) {
          const base = parseFloat(groupeData[matosNom].tarif) || 0;

          return base;
        }
        return 0;
      }

      function getICClient(clientNom, matosNom) {
        const groupeNom = transportConfigClient[clientNom];
        if (!groupeNom) return 0;

        const groupeData = transportConfigGroup[groupeNom];
        if (groupeData && groupeData[matosNom]) {
          const tarif = parseFloat(groupeData[matosNom].tarif) || 0;

          const dateValeur = document.getElementById(
            "current-date-picker",
          ).value;
          const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "default";

          let indice = 0;
          const indiceData = groupeData[matosNom].indice;

          if (typeof indiceData === "object") {
            indice = parseFloat(indiceData[moisAnnee]) || 0;
          } else {
            indice = parseFloat(indiceData) || 0;
          }
          if (indice === 0) {
            const catDuMatos = transportConfigMateriel[matosNom];
            if (
              catDuMatos &&
              transportConfigGroupInfo[groupeNom] &&
              transportConfigGroupInfo[groupeNom][catDuMatos]
            ) {
              indice = parseFloat(
                transportConfigGroupInfo[groupeNom][catDuMatos],
              );
            }
          }

          return tarif * (indice / 100);
        }
        return 0;
      }

      function getICAffrete(associeNom, matosNom) {
        if (!associeNom || !matosNom || !transportConfigAssocie[associeNom])
          return 0;

        const data = transportConfigAssocie[associeNom][matosNom];
        if (!data) return 0;

        const tarif = parseFloat(data.tarif) || 0;

        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "default";

        let indice = 0;
        const indiceData = groupeData[matosNom].indice;

        if (typeof indiceData === "object") {
          indice = parseFloat(indiceData[moisAnnee]) || 0;
        } else {
          indice = parseFloat(indiceData) || 0;
        }
        if (indice === 0) {
          const catDuMatos = transportConfigMateriel[matosNom];
          if (
            catDuMatos &&
            transportConfigGroupInfo[associeNom] &&
            transportConfigGroupInfo[associeNom][catDuMatos]
          ) {
            indice = parseFloat(
              transportConfigGroupInfo[associeNom][catDuMatos],
            );
          }
        }

        return tarif * (indice / 100);
      }

      function addGlobalMatos(type) {
        let inputId =
          type === "client" ? "global-matos-client" : "global-matos-associe";
        let val = document.getElementById(inputId).value.trim().toUpperCase();

        if (!val) return;

        for (let groupName in transportConfigGroup) {
          if (!transportConfigGroup[groupName][val]) {
            transportConfigGroup[groupName][val] = { tarif: 0, indice: 0 };
          }
        }

        for (let associeName in transportConfigAssocie) {
          if (!transportConfigAssocie[associeName][val]) {
            transportConfigAssocie[associeName][val] = { tarif: 0, indice: 0 };
          }
        }

        localStorage.setItem(
          "transport_config_group",
          JSON.stringify(transportConfigGroup),
        );
        localStorage.setItem(
          "transport_config_associe",
          JSON.stringify(transportConfigAssocie),
        );

        document.getElementById(inputId).value = "";
        renderConfigUI();
        renderConfigUI2();
        if (typeof updateMatosDatalist === "function") updateMatosDatalist();
      }

      function deleteGlobalMatos(type, matosNom) {
        if (
          confirm(
            `Supprimer d√©finitivement "${matosNom}" de TOUS les Groupes (Clients) et de TOUS les Associ√©s ?`,
          )
        ) {
          for (let g in transportConfigGroup) {
            if (transportConfigGroup[g][matosNom] !== undefined) {
              delete transportConfigGroup[g][matosNom];
            }
          }

          for (let a in transportConfigAssocie) {
            if (transportConfigAssocie[a][matosNom] !== undefined) {
              delete transportConfigAssocie[a][matosNom];
            }
          }

          if (transportConfigMateriel[matosNom]) {
            delete transportConfigMateriel[matosNom];
          }

          localStorage.setItem(
            "transport_config_group",
            JSON.stringify(transportConfigGroup),
          );
          localStorage.setItem(
            "transport_config_associe",
            JSON.stringify(transportConfigAssocie),
          );
          localStorage.setItem(
            "transport_config_materiel",
            JSON.stringify(transportConfigMateriel),
          );

          renderConfigUI();
          renderConfigUI2();
          if (typeof updateMatosDatalist === "function") updateMatosDatalist();

          const sn = document.getElementById("save-notif");
          if (sn) {
            sn.textContent = `"${matosNom}" supprim√© partout.`;
            sn.style.display = "inline";
            setTimeout(() => (sn.style.display = "none"), 2000);
          }
        }
      }

      function trierPlanningParAssocie() {
        const tableBody = document.getElementById("table-body");
        const rows = Array.from(tableBody.querySelectorAll("tr"));
        const baseAssocies = ["ALLARD", "LANDAIS", "STD"];

        const rowsToSort = rows.filter(
          (tr) => !tr.classList.contains("group-separator"),
        );

        rowsToSort.sort((a, b) => {
          const valA =
            a.querySelector(".select-associe")?.value.toUpperCase() || "";
          const valB =
            b.querySelector(".select-associe")?.value.toUpperCase() || "";

          if (valA === "" && valB === "") return 0;
          if (valA === "") return 1;
          if (valB === "") return -1;

          const isABase = baseAssocies.includes(valA);
          const isBBase = baseAssocies.includes(valB);

          // R√®gle de priorit√©
          if (isABase && !isBBase) return -1;
          if (!isABase && isBBase) return 1;

          const compareAssocie = valA.localeCompare(valB);

          if (compareAssocie !== 0) return compareAssocie;

          const matosA =
            a.querySelector(".select-vehicule")?.value.toUpperCase() || "";
          const matosB =
            b.querySelector(".select-vehicule")?.value.toUpperCase() || "";

          if (matosA === "" && matosB === "") return 0;
          if (matosA === "") return 1;
          if (matosB === "") return -1;

          // Tri alphab√©tique pour le reste
          return matosA.localeCompare(matosB);
        });

        rowsToSort.forEach((tr) => tableBody.appendChild(tr));
      }

      function renderConfigUI() {
        const container = document.getElementById("config-container");

        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "";
        let html = `<h3>Tarifs par Groupe</h3>
                                  <table class="config-table">
                                    <thead>
                                      <tr>
                                        <th>Groupe</th>
                                        <th style="width: 20%;">Cat√©gorie</th>
                                        <th style="width: 25%;">Mat√©riel</th>
                                        <th style="width: 13%;">Tarif (‚Ç¨)</th>
                                        <th style="width: 10%;">Indice (%)</th>
                                        <th>Action</th>
                                      </tr>
                                    </thead><tbody>`;

        const groups = Object.keys(transportConfigGroup).sort();
        const categorie = Object.keys(transportConfigCategorie).sort();

        if (groups.length === 0) {
          html += `<tr><td colspan="6"><i>Aucun groupe configur√©...</i></td></tr>`;
        } else {
          groups.forEach((group, index) => {
            if (index > 0) {
              html += `<tr style="background-color: white;"><td colspan="6" style="height: 25px; border: none;"></td></tr>`;
            }
            let matosKeys = Object.keys(transportConfigGroup[group]).sort();

            if (matosKeys.length === 0) {
              html += `<tr>
                              <td class="group-header"><strong>${group}</strong></td>
                              <td colspan="5">Aucun mat√©riel - <button onclick="deleteGroup('${group}')" class="btn-delete">Supprimer</button></td>
                            </tr>`;
            } else {
              matosKeys.forEach((matos, index) => {
                const val = transportConfigGroup[group][matos];
                const currentCat = transportConfigMateriel[matos] || "";

                let indiceAafficher = 0;
                let isUsingCategory = false;

                // üîπ R√©cup√©rer l'indice du mois actuel (si stock√© par mois)
                if (typeof val.indice === "object") {
                  indiceAafficher = val.indice[moisAnnee] || 0;
                } else {
                  indiceAafficher = val.indice || 0;
                }

                // üîπ Si pas d'indice sp√©cifique, utiliser celui de la cat√©gorie
                if (indiceAafficher === 0 && currentCat) {
                  if (
                    transportConfigGroupInfo[group] &&
                    transportConfigGroupInfo[group][currentCat]
                  ) {
                    const dataCat = transportConfigGroupInfo[group][currentCat];
                    indiceAafficher =
                      typeof dataCat === "object"
                        ? dataCat[moisAnnee] || 0
                        : dataCat;
                    isUsingCategory = true;
                  }
                }

                html += `<tr>
                        ${
                          index === 0
                            ? `<td rowspan="${matosKeys.length}" class="group-header" style="vertical-align: top;">
                                <strong>${group}</strong><br>
                                <button onclick="deleteGroup('${group}')" class="btn-delete" style="margin-top:5px;">Supprimer</button>
                                <div style="margin-top:15px; border-top: 1px solid #ccc; padding-top:10px;">
                                  <p style="font-weight:bold; font-size:0.85em; margin-bottom:10px; color:#555;">Indices Carburant par Cat√©gorie :</p>
                                  ${categorie
                                    .map((cat) => {
                                      let valIndice = 0;
                                      if (
                                        transportConfigGroupInfo[group] &&
                                        transportConfigGroupInfo[group][cat]
                                      ) {
                                        const data =
                                          transportConfigGroupInfo[group][cat];
                                        valIndice =
                                          typeof data === "object"
                                            ? data[moisAnnee] || 0
                                            : data;
                                      }
                                      return `
                                        <div style="margin-bottom:8px; text-align:left; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">
                                          <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <label style="font-size: 0.75em; color:#333; font-weight: bold;">${cat} (%) :</label>
                                            <button onclick="deleteCategorie('${cat}')" style="background:none; border:none; color:red; cursor:pointer; font-size:10px;">X</button>
                                          </div>
                                          <input type="number" step="0.01" value="${valIndice !== 0 ? valIndice : ""}"
                                                onchange="updateGroupCatIndice('${group}', '${cat}', this.value)"
                                                style="width:100%; padding: 3px; font-size:0.85em; text-align: center;">
                                        </div>
                                      `;
                                    })
                                    .join("")}
                                </div>
                              </td>`
                            : ""
                        }
                        <td style="text-align:left; padding-left:10px;">
                            <select onchange="setMaterielCategorie('${matos}', this.value)" style="width:100%; padding: 4px;">
                                <option value="">-- Sans --</option>
                                ${categorie
                                  .map(
                                    (c) =>
                                      `<option value="${c}" ${
                                        currentCat === c ? "selected" : ""
                                      }>${c}</option>`,
                                  )
                                  .join("")}
                            </select>
                        </td>
                        <td>${matos}</td>
                        <td>
                          <input type="number" step="0.01" value="${val.tarif}"
                            onchange="updateGroupPrice('${group}', '${matos}', this.value)"
                            style="width:100%;">
                        </td>
                        <td>
                          <input type="number" step="0.01"
                            value="${indiceAafficher !== 0 ? indiceAafficher : ""}"
                            placeholder="${isUsingCategory ? "H√©rit√©" : ""}"
                            onchange="updateGroupIndice('${group}', '${matos}', this.value)"
                            style="width:100%; ${
                              isUsingCategory
                                ? "color: #1a73e8; font-style: italic; background: #f1f3f4;"
                                : "font-weight: bold;"
                            }">
                        </td>
                        <td>
                            <button class="del-matos-btn" onclick="deleteGlobalMatos('client', '${matos}')" style="color:red; cursor:pointer;">x</button>
                        </td>
                      </tr>`;
              });
            }
          });
        }

        html += `</tbody></table>`;

        html += `<h3 style="margin-top:30px;">Assignation des Clients</h3>
                                   <table class="config-table">
                                     <thead>
                                       <tr>
                                         <th style="width: 40%;">Client</th>
                                         <th style="width: 40%;">Groupe assign√©</th>
                                         <th style="width: 20%;">Action</th>
                                       </tr>
                                     </thead><tbody>`;

        const clients = Object.keys(transportConfigClient).sort();
        if (clients.length === 0) {
          html += `<tr><td colspan="3"><i>Aucun client configur√©.</i></td></tr>`;
        } else {
          clients.forEach((client) => {
            const assignedGroup = transportConfigClient[client];
            html += `<tr>
                                        <td><strong>${client}</strong></td>
                                        <td>
                                          <select onchange="setClientGroup('${client}', this.value)" style="width:100%; padding:4px;">
                                            <option value="">-- Aucun groupe --</option>
                                            ${groups
                                              .map(
                                                (g) =>
                                                  `<option value="${g}" ${
                                                    assignedGroup === g
                                                      ? "selected"
                                                      : ""
                                                  }>${g}</option>`,
                                              )
                                              .join("")}
                                          </select>
                                        </td>
                                        <td><button onclick="deleteClient('${client}')" class="btn-delete">Supprimer</button></td>
                                      </tr>`;
          });
        }

        container.innerHTML = html + `</tbody></table>`;
      }

      function updateGroupCatIndice(associe, categorie, valeur) {
        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "default";

        if (!transportConfigGroupInfo[associe]) {
          transportConfigGroupInfo[associe] = {};
        }

        // 2. On transforme la donn√©e en objet si ce n'est pas d√©j√† fait
        if (typeof transportConfigGroupInfo[associe][categorie] !== "object") {
          transportConfigGroupInfo[associe][categorie] = {};
        }

        // 3. On enregistre la valeur sp√©cifiquement pour ce mois
        transportConfigGroupInfo[associe][categorie][moisAnnee] =
          parseFloat(valeur) || 0;

        // ‚úÖ SAUVEGARDER
        sauvegarderConfig();

        // ‚úÖ RAFRA√éCHIR
        renderConfigUI();
        renderConfigUI2();
        refreshAllPlanningTarifs();
      }

      function updateGroupPrice(group, matos, price) {
        if (!transportConfigGroup[group][matos]) {
          transportConfigGroup[group][matos] = { tarif: 0, indice: 0 };
        }
        transportConfigGroup[group][matos].tarif = parseFloat(price) || 0;
        localStorage.setItem(
          "transport_config_group",
          JSON.stringify(transportConfigGroup),
        );
        refreshAllPlanningTarifs();
      }

      function sauvegarderConfig() {
        localStorage.setItem(
          "transport_config_group",
          JSON.stringify(transportConfigGroup),
        );
        localStorage.setItem(
          "transportConfigGroupInfo",
          JSON.stringify(transportConfigGroupInfo),
        );
        localStorage.setItem(
          "transport_config_associe",
          JSON.stringify(transportConfigAssocie),
        );
      }

      function updateGroupIndice(group, matos, indice) {
        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "default";

        if (!transportConfigGroup[group][matos]) {
          transportConfigGroup[group][matos] = { tarif: 0, indice: {} };
        }

        // üîπ Transformer en objet temporel si ce n'est pas d√©j√† fait
        if (typeof transportConfigGroup[group][matos].indice !== "object") {
          transportConfigGroup[group][matos].indice = {};
        }

        // üîπ Enregistrer l'indice pour CE mois uniquement
        transportConfigGroup[group][matos].indice[moisAnnee] =
          parseFloat(indice) || 0;

        // ‚úÖ SAUVEGARDER AVANT DE RAFRA√éCHIR
        sauvegarderConfig();

        // ‚úÖ RAFRA√éCHIR L'INTERFACE
        renderConfigUI();
        refreshAllPlanningTarifs();
      }

      function deleteCategorie(catNom) {
        if (
          confirm(
            `Voulez-vous vraiment supprimer la cat√©gorie "${catNom}" ?\n(Les mat√©riels n'auront plus de cat√©gorie assign√©e).`,
          )
        ) {
          delete transportConfigCategorie[catNom];
          localStorage.setItem(
            "transport_config_categorie",
            JSON.stringify(transportConfigCategorie),
          );

          for (let group in transportConfigGroupInfo) {
            if (transportConfigGroupInfo[group][catNom] !== undefined) {
              delete transportConfigGroupInfo[group][catNom];
            }
          }
          localStorage.setItem(
            "transportConfigGroupInfo",
            JSON.stringify(transportConfigGroupInfo),
          );

          for (let matos in transportConfigMateriel) {
            if (transportConfigMateriel[matos] === catNom) {
              transportConfigMateriel[matos] = "";
            }
          }
          localStorage.setItem(
            "transport_config_materiel",
            JSON.stringify(transportConfigMateriel),
          );

          renderConfigUI();
          renderConfigUI2();

          if (typeof renderCategorieManager === "function")
            renderCategorieManager();

          const sn = document.getElementById("save-notif");
          if (sn) {
            sn.textContent = `Cat√©gorie "${catNom}" supprim√©e.`;
            sn.style.display = "inline";
            setTimeout(() => (sn.style.display = "none"), 2000);
          }
        }
      }

      function renderCategorieManager() {
        const container = document.getElementById(
          "categorie-manager-container",
        );
        if (!container) return;

        const cats = Object.keys(transportConfigCategorie).sort();

        let html = `<h3>Gestion des Cat√©gories</h3>
                                        <ul style="list-style: none; padding: 0; max-width: 400px;">`;

        cats.forEach((cat) => {
          html += `
                                    <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                                        <span>${cat}</span>
                                        <button onclick="deleteCategorie('${cat}')"
                                                style="color: white; background: #dc3545; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                            Supprimer
                                        </button>
                                    </li>`;
        });

        html += `</ul>`;
        container.innerHTML = html;
      }

      function updateConfigValue(c, m, f, v) {
        if (typeof transportConfigClient[c][m] !== "object") {
          const old = transportConfigClient[c][m] || 0;
          transportConfigClient[c][m] = { tarif: old, indice: 0 };
        }
        transportConfigClient[c][m][f] = parseFloat(v) || 0;
      }

      function addNewClient() {
        const name = document
          .getElementById("new-client-name")
          .value.trim()
          .toUpperCase();
        if (!name || transportConfigClient[name]) return;

        transportConfigClient[name] = "";

        localStorage.setItem(
          "transport_config_client",
          JSON.stringify(transportConfigClient),
        );
        document.getElementById("new-client-name").value = "";
        renderConfigUI();
        updateMatosDatalist();
      }

      function deleteClient(c) {
        if (confirm("Supprimer ce client ?")) {
          delete transportConfigClient[c];
          localStorage.setItem(
            "transport_config_client",
            JSON.stringify(transportConfigClient),
          );
          renderConfigUI();
        }
      }

      function addNewGroup() {
        const name = document
          .getElementById("new-group-name")
          .value.trim()
          .toUpperCase();

        if (!name) return;
        if (transportConfigGroup[name]) {
          alert("Ce groupe existe d√©j√†");
          return;
        }

        const fullMatosList = new Set(defaultMatosList);

        for (let group in transportConfigGroup) {
          Object.keys(transportConfigGroup[group]).forEach((m) =>
            fullMatosList.add(m),
          );
        }

        for (let associe in transportConfigAssocie) {
          Object.keys(transportConfigAssocie[associe]).forEach((m) =>
            fullMatosList.add(m),
          );
        }

        transportConfigGroup[name] = {};

        fullMatosList.forEach((m) => {
          transportConfigGroup[name][m] = { tarif: 0, indice: 0 };
        });

        localStorage.setItem(
          "transport_config_group",
          JSON.stringify(transportConfigGroup),
        );

        document.getElementById("new-group-name").value = "";
        renderConfigUI();

        const sn = document.getElementById("save-notif");
        sn.textContent =
          "Groupe " + name + " cr√©√© avec tous les mat√©riels actuels !";
        sn.style.display = "inline";
        setTimeout(() => (sn.style.display = "none"), 2000);
      }

      function deleteGroup(name) {
        if (confirm(`Supprimer le groupe "${name}" ?`)) {
          delete transportConfigGroup[name];
          for (let c in transportConfigClient) {
            if (transportConfigClient[c] === name)
              transportConfigClient[c] = "";
          }
          localStorage.setItem(
            "transport_config_group",
            JSON.stringify(transportConfigGroup),
          );
          localStorage.setItem(
            "transport_config_client",
            JSON.stringify(transportConfigClient),
          );
          renderConfigUI();
        }
      }

      function getClientGroup(client) {
        for (let group in transportConfigGroup) {
          if (transportConfigGroup[group].includes(client)) return group;
        }
        return "";
      }

      function setClientGroup(client, groupName) {
        transportConfigClient[client] = groupName;
        localStorage.setItem(
          "transport_config_client",
          JSON.stringify(transportConfigClient),
        );
        const sn = document.getElementById("save-notif");
        sn.textContent = "Client assign√© au groupe !";
        sn.style.display = "inline";
        setTimeout(() => (sn.style.display = "none"), 2000);
      }

      function addCategorie(type) {
        const inputId =
          type === "associe"
            ? "global-categorie-associe"
            : "global-categorie-client";

        const input = document.getElementById(inputId);
        if (!input) return;

        const name = input.value.trim().toUpperCase();
        if (!name) return;

        if (!transportConfigCategorie[name]) {
          transportConfigCategorie[name] = true;

          localStorage.setItem(
            "transport_config_categorie",
            JSON.stringify(transportConfigCategorie),
          );

          input.value = "";
          renderConfigUI();
          renderConfigUI2();

          const sn = document.getElementById("save-notif");
          sn.textContent = "Cat√©gorie " + name + " cr√©√©e !";
          sn.style.display = "inline";
          setTimeout(() => (sn.style.display = "none"), 2000);
        }
      }

      function setMaterielCategorie(matos, categorieName) {
        transportConfigMateriel[matos] = categorieName;
        localStorage.setItem(
          "transport_config_materiel",
          JSON.stringify(transportConfigMateriel),
        );

        renderConfigUI();
        renderConfigUI2();
        refreshAllPlanningTarifs();

        const sn = document.getElementById("save-notif");
        if (sn) {
          sn.textContent = "Cat√©gorie mise √† jour !";
          sn.style.display = "inline";
          setTimeout(() => (sn.style.display = "none"), 2000);
        }
      }

      function updateRowTarif(tr) {
        const dateLigne = tr.cells[4]?.innerText || "";
        const estMemeMois = estMemeMoisQueSelection(dateLigne);

        if (!estMemeMois && tr.dataset.snapshot) {
          const snapshot = JSON.parse(tr.dataset.snapshot);
          applySnapshotToRow(tr, snapshot);
          saveCurrentDay();
          return;
        }

        // Pas de snapshot = nouvelle ligne ou modification manuelle
        // On continue avec la logique actuelle
        const eventTrigger = window.event ? window.event.target : null;
        const isComboChange =
          eventTrigger && eventTrigger.classList.contains("combo-input");

        const client = tr.querySelector(".select-client").value;
        const associe = tr.querySelector(".select-associe").value;
        const matos = tr.querySelector(".select-vehicule").value;

        const cellTarifClient = tr.querySelector(".cell-tarif");
        const cellTarifAffrete = tr.querySelector(".cell-tarif-affrete");
        const cellICClient = tr.querySelector(".cell-IC-client");
        const cellICAffrete = tr.querySelector(".cell-IC-affrete");

        // --- PARTIE CLIENT ---
        if (client && matos) {
          let tarifC =
            parseFloat(
              cellTarifClient.textContent
                .replace(/[‚Ç¨\s]/g, "")
                .replace(",", "."),
            ) || 0;

          if (isComboChange || tarifC === 0) {
            tarifC = getTarifClient(client, matos);
          }

          if (document.activeElement !== cellTarifClient) {
            cellTarifClient.textContent = tarifC.toFixed(2) + " ‚Ç¨";
          }

          const groupeNom = transportConfigClient[client];
          let indiceC = 0;
          if (
            transportConfigGroup[groupeNom] &&
            transportConfigGroup[groupeNom][matos]
          ) {
            indiceC =
              parseFloat(transportConfigGroup[groupeNom][matos].indice) || 0;
            if (indiceC === 0) {
              const cat = transportConfigMateriel[matos];
              if (cat && transportConfigGroupInfo[groupeNom]) {
                indiceC =
                  parseFloat(transportConfigGroupInfo[groupeNom][cat]) || 0;
              }
            }
          }
          const icC = tarifC * (indiceC / 100);
          cellICClient.textContent = icC.toFixed(2) + " ‚Ç¨";
          cellICClient.style.color =
            icC > 0 ? "#28a745" : icC < 0 ? "#dc3545" : "#95a5a6";
          cellICClient.style.fontWeight = icC !== 0 ? "bold" : "normal";
        } else {
          if (document.activeElement !== cellTarifClient)
            cellTarifClient.textContent = "0.00 ‚Ç¨";
          cellICClient.textContent = "0.00 ‚Ç¨";
        }

        // --- PARTIE AFFR√âT√â ---
        if (associe && matos && client) {
          let tarifA =
            parseFloat(
              cellTarifAffrete.textContent
                .replace(/[‚Ç¨\s]/g, "")
                .replace(",", "."),
            ) || 0;

          if (isComboChange || tarifA === 0) {
            if (
              transportConfigAssocie[associe] &&
              transportConfigAssocie[associe][matos]
            ) {
              tarifA =
                parseFloat(transportConfigAssocie[associe][matos].tarif) || 0;
            }
          }

          if (document.activeElement !== cellTarifAffrete) {
            cellTarifAffrete.textContent = tarifA.toFixed(2) + " ‚Ç¨";
          }

          let indiceA = 0;
          if (
            transportConfigAssocie[associe] &&
            transportConfigAssocie[associe][matos]
          ) {
            indiceA =
              parseFloat(transportConfigAssocie[associe][matos].indice) || 0;
            if (indiceA === 0) {
              const catA = transportConfigMateriel[matos];
              if (catA && transportConfigGroupInfo[associe]) {
                indiceA =
                  parseFloat(transportConfigGroupInfo[associe][catA]) || 0;
              }
            }
          }
          const icA = tarifA * (indiceA / 100);
          cellICAffrete.textContent = icA.toFixed(2) + " ‚Ç¨";
          cellICAffrete.style.color =
            icA > 0 ? "#28a745" : icA < 0 ? "#dc3545" : "#95a5a6";
          cellICAffrete.style.fontWeight = icA !== 0 ? "bold" : "normal";
        } else {
          if (document.activeElement !== cellTarifAffrete)
            cellTarifAffrete.textContent = "0.00 ‚Ç¨";
          cellICAffrete.textContent = "0.00 ‚Ç¨";
        }

        saveCurrentDay();
        if (estMemeMois) {
          if ((client && matos) || (associe && matos)) {
            const snapshot = createSnapshotFromRow(tr);
            tr.dataset.snapshot = JSON.stringify(snapshot);
          }
        }
        calculerTousLesTotaux();
      }

      function updateRowHighlight(tr) {
        const bonCell = tr.querySelector(".cell-bon");
        if (!bonCell) return;

        const texte = bonCell.textContent.trim();
        // La ligne est consid√©r√©e "remplie" si elle n'est pas vide ET qu'elle ne contient pas le placeholder
        const hasBon = texte !== "" && texte !== "N¬∞ Bon...";

        const cells = tr.querySelectorAll("td");

        cells.forEach((td) => {
          if (hasBon) {
            td.style.backgroundColor = "#d4edda"; // Vert si bon rempli
          } else {
            // Si pas de bon, on laisse la logique de appliquerCouleurAssocie g√©rer
            // On ne remet en blanc que les cellules qui ne sont pas l'associ√©
            if (!td.querySelector(".select-associe")) {
              td.style.backgroundColor = "";
            } else {
              appliquerCouleurAssocie(td.querySelector(".select-associe"));
            }
          }
        });
      }

      function refreshAllPlanningTarifs() {
        const rows = document.querySelectorAll("#table-body tr");
        rows.forEach((tr) => {
          const dateLigne = tr.cells[4]?.innerText || "";
          const estMemeMois = estMemeMoisQueSelection(dateLigne);

          if (!estMemeMois) {
            // Si hors mois, on restaure le snapshot s'il existe
            if (tr.dataset.snapshot) {
              const snapshot = JSON.parse(tr.dataset.snapshot);
              applySnapshotToRow(tr, snapshot);
            }
            return;
          }

          // On r√©cup√®re les valeurs actuelles pour forcer le recalcul
          const client = tr.querySelector(".select-client")?.value;
          const matos = tr.querySelector(".select-vehicule")?.value;
          const associe = tr.querySelector(".select-associe")?.value;

          // On appelle tes fonctions de calcul existantes
          if (client && matos) {
            const tarifC = getTarifClient(client, matos);
            const icC = getICClient(client, matos);
            tr.querySelector(".cell-tarif").textContent =
              tarifC.toFixed(2) + " ‚Ç¨";
            tr.querySelector(".cell-IC-client").textContent =
              icC.toFixed(2) + " ‚Ç¨";
          }

          if (associe && matos) {
            const tarifA =
              transportConfigAssocie[associe] &&
              transportConfigAssocie[associe][matos]
                ? parseFloat(transportConfigAssocie[associe][matos].tarif) || 0
                : 0;
            const icA = getICAffrete(associe, matos);
            tr.querySelector(".cell-tarif-affrete").textContent =
              tarifA.toFixed(2) + " ‚Ç¨";
            tr.querySelector(".cell-IC-affrete").textContent =
              icA.toFixed(2) + " ‚Ç¨";
          }
          if ((client && matos) || (associe && matos)) {
            const snapshot = captureSnapshot(client, matos, associe);
            tr.dataset.snapshot = JSON.stringify(snapshot);
          }
        });

        calculerTousLesTotaux();
      }

      function renderConfigUI2() {
        const container = document.getElementById("config-container-2");
        const associeListDatalist = document.getElementById("list-associe");
        if (!container) return;

        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "";

        associeListDatalist.innerHTML = "";
        const baseAssocies = ["ALLARD", "LANDAIS", "STD"];
        const allAssociesSet = new Set([
          ...Object.keys(transportConfigAssocie),
        ]);

        Array.from(allAssociesSet)
          .sort()
          .forEach((name) => {
            associeListDatalist.innerHTML += `<option value="${name}">`;
          });

        const groupePiliers = Array.from(allAssociesSet)
          .filter((name) => baseAssocies.includes(name.toUpperCase()))
          .sort((a, b) => a.localeCompare(b));

        const groupeAffretes = Array.from(allAssociesSet)
          .filter((name) => !baseAssocies.includes(name.toUpperCase()))
          .sort((a, b) => a.localeCompare(b));

        const sortedEntries = [...groupePiliers, ...groupeAffretes];

        let html = `<table class="config-table"><thead><tr><th>Associ√©</th><th style="width: 20%;">Cat√©gorie</th><th style="width: 25%;">Mat√©riel</th><th style="width: 13%;">Tarif (‚Ç¨)</th><th style="width: 10%;">Indice (%)</th><th>Actions</th></tr></thead><tbody>`;

        const categories = Object.keys(transportConfigCategorie).sort();
        const allGlobalMaterials = Object.keys(transportConfigMateriel).sort();

        if (sortedEntries.length === 0) {
          html += `<tr><td colspan="6"><i>Aucun associ√© configur√©.</i></td></tr>`;
        } else {
          sortedEntries.forEach((entry, index) => {
            // Ajout d'un espace entre chaque bloc d'associ√©
            if (index > 0) {
              html += `<tr style="background-color: white;"><td colspan="6" style="height: 25px; border: none;"></td></tr>`;
            }

            // --- NOUVEAU : AJOUT D'UN BANDEAU S√âPARATEUR ---
            const estPilier = baseAssocies.includes(entry.toUpperCase());
            const precedentEtaitPilier =
              index > 0 &&
              baseAssocies.includes(sortedEntries[index - 1].toUpperCase());

            if (index > 0 && !estPilier && precedentEtaitPilier) {
              html += `<tr style="background-color: #f1f3f4;"><td colspan="6" style="text-align:center; font-weight:bold; color:#5f6368; padding:10px; border:1px solid #dee2e6;">AUTRES AFFR√âT√âS</td></tr>`;
            }

            if (!transportConfigAssocie[entry]) {
              transportConfigAssocie[entry] = {};
            }

            const keys = Array.from(
              new Set([
                ...allGlobalMaterials,
                ...Object.keys(transportConfigAssocie[entry]),
              ]),
            ).sort();
            const rowSpanCount = Math.max(1, keys.length);

            // BLOC DE GAUCHE (NOM + BOUTON SUPPRIMER)
            const leftBlockHTML = `
                                <td rowspan="${rowSpanCount}" class="group-header" style="vertical-align: top; background-color: #f8f9fa;">
                                    <strong>${entry}</strong><br>

                                    <button class="btn-delete" style="margin-top:5px;" onclick="deleteEntry2('${entry}')">Supprimer</button>

                                    <div style="margin-top:15px; border-top: 1px solid #ccc; padding-top:10px;">
                                        <p style="font-weight:bold; font-size:0.85em; margin-bottom:10px; color:#555;">Indices Carburant / Cat :</p>
                                        ${categories
                                          .map((cat) => {
                                            let valIndice = 0;
                                            if (
                                              transportConfigGroupInfo[entry] &&
                                              transportConfigGroupInfo[entry][
                                                cat
                                              ]
                                            ) {
                                              const data =
                                                transportConfigGroupInfo[entry][
                                                  cat
                                                ];
                                              valIndice =
                                                typeof data === "object"
                                                  ? data[moisAnnee] || 0
                                                  : data;
                                            }
                                            return `
                                            <div style="margin-bottom:8px; text-align:left; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">
                                                      <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <label style="font-size: 0.75em; color:#333; font-weight: bold;">${cat} (%) :</label>
                                                        <button onclick="deleteCategorie('${cat}')" style="background:none; border:none; color:red; cursor:pointer; font-size:10px;">X</button>
                                                      </div>
                                                      <input type="number" step="0.01" value="${valIndice !== 0 ? valIndice : ""}"
                                                      onchange="updateGroupCatIndice('${entry}', '${cat}', this.value)"
                                                      style="width:100%; padding: 3px; font-size:0.85em; text-align: center;">
                                            </div>`;
                                          })
                                          .join("")}
                                    </div>
                                </td>`;

            // LIGNES DE MAT√âRIELS
            keys.forEach((k, idx) => {
              if (!transportConfigAssocie[entry][k]) {
                transportConfigAssocie[entry][k] = { tarif: 0, indice: 0 };
              }
              const val = transportConfigAssocie[entry][k];
              const currentCat = transportConfigMateriel[k] || "";

              let indiceAafficher = val.indice || 0;
              let isUsingCategory = false;

              if ((!val.indice || val.indice === 0) && currentCat) {
                if (
                  transportConfigGroupInfo[entry] &&
                  transportConfigGroupInfo[entry][currentCat]
                ) {
                  const dataCat = transportConfigGroupInfo[entry][currentCat];
                  indiceAafficher =
                    typeof dataCat === "object"
                      ? dataCat[moisAnnee] || 0
                      : dataCat;
                  isUsingCategory = true;
                }
              }

              html += `<tr>
                            ${idx === 0 ? leftBlockHTML : ""}
                            <td style="text-align:left; padding-left:10px;">
                                <select onchange="setMaterielCategorie('${k}', this.value)" style="width:100%; padding:4px;">
                                    <option value="">-- Sans --</option>
                                    ${categories.map((c) => `<option value="${c}" ${currentCat === c ? "selected" : ""}>${c}</option>`).join("")}
                                </select>
                            </td>
                            <td>${k}</td>
                            <td>
                                <input type="number" step="0.01" value="${val.tarif || 0}"
                                      onchange="updateAssocieTarif('${entry}', '${k}', this.value)"
                                      style="width:100%;">
                            </td>
                            <td>
                                <input type="number" step="0.01" value="${indiceAafficher !== 0 ? indiceAafficher : ""}"
                                      placeholder="${isUsingCategory ? "H√©rit√©" : ""}"
                                      onchange="updateAssocieIndice('${entry}', '${k}', this.value)"
                                      style="width:100%; ${isUsingCategory ? "color: #1a73e8; font-style: italic; background: #f1f3f4;" : "font-weight: bold;"}">
                            </td>
                            <td>
                                <button class="del-matos-btn" onclick="deleteGlobalMatos('associe', '${k}')" style="color:red; cursor:pointer;">x</button>
                            </td>
                        </tr>`;
            });
          });
        }

        container.innerHTML = html + `</tbody></table>`;
        trierDatalist("list-associe");
      }

      function updateAssocieTarif(entry, mat, val) {
        transportConfigAssocie[entry][mat].tarif = parseFloat(val) || 0;
        localStorage.setItem(
          "transport_config_associe",
          JSON.stringify(transportConfigAssocie),
        );
        refreshAllPlanningTarifs();
      }

      function updateAssocieIndice(entry, mat, val) {
        const dateValeur = document.getElementById("current-date-picker").value;
        const moisAnnee = dateValeur ? dateValeur.substring(0, 7) : "default";

        if (!transportConfigAssocie[entry][mat]) {
          transportConfigAssocie[entry][mat] = { tarif: 0, indice: {} };
        }

        // üîπ Transformer en objet temporel
        if (typeof transportConfigAssocie[entry][mat].indice !== "object") {
          transportConfigAssocie[entry][mat].indice = {};
        }

        transportConfigAssocie[entry][mat].indice[moisAnnee] =
          parseFloat(val) || 0;

        // ‚úÖ SAUVEGARDER AVANT DE RAFRA√éCHIR
        sauvegarderConfig();

        renderConfigUI2();
        refreshAllPlanningTarifs();
      }

      function addNewClient2() {
        const input = document.getElementById("new-config2-name");
        const name = input.value.trim().toUpperCase();

        // S√©curit√© : nom vide ou d√©j√† existant
        if (!name || transportConfigAssocie[name]) return;

        // 1. On pr√©pare la liste de tous les mat√©riels existants (ton code actuel)
        const fullMatosList = new Set(defaultMatosList);

        for (let group in transportConfigGroup) {
          Object.keys(transportConfigGroup[group]).forEach((m) =>
            fullMatosList.add(m),
          );
        }

        for (let associe in transportConfigAssocie) {
          Object.keys(transportConfigAssocie[associe]).forEach((m) =>
            fullMatosList.add(m),
          );
        }

        // 2. On cr√©e l'entr√©e dans l'objet de configuration
        transportConfigAssocie[name] = {};
        fullMatosList.forEach((m) => {
          transportConfigAssocie[name][m] = { tarif: 0, indice: 0 };
        });

        // 3. Sauvegarde dans le localStorage
        localStorage.setItem(
          "transport_config_associe",
          JSON.stringify(transportConfigAssocie),
        );

        // 4. Reset de l'interface
        input.value = "";

        // 5. On appelle le rendu (qui lui g√©rera le tri groupe principal vs secondaire)
        renderConfigUI2();
        updateMatosDatalist();
      }

      function deleteEntry2(e) {
        if (confirm("Supprimer cet associ√© ?")) {
          delete transportConfigAssocie[e];
          localStorage.setItem(
            "transport_config_associe",
            JSON.stringify(transportConfigAssocie),
          );
          renderConfigUI2();
        }
      }

      function renderConfigUIChauffeur() {
        const container = document.getElementById("config-container-chauffeur");
        const chauffeurListDatalist = document.getElementById("list-chauffeur");
        chauffeurListDatalist.innerHTML = "";

        const allChauffeurs = new Set([
          ...defaultChauffeursList,
          ...Object.keys(transportConfigChauffeur),
        ]);

        Array.from(allChauffeurs)
          .sort()
          .forEach((name) => {
            chauffeurListDatalist.innerHTML += `<option value="${name}">`;
          });

        let html = `<table class="config-table"><thead><tr><th>Chauffeur</th><th>Actions</th></tr></thead><tbody>`;

        const sortedEntries = Object.keys(transportConfigChauffeur).sort();

        if (sortedEntries.length === 0) {
          html += `<tr><td colspan="2"><i>Aucun chauffeur configur√© manuellement. Utilisez le bouton "Cr√©er Chauffeur" pour en ajouter.</i></td></tr>`;
        } else {
          sortedEntries.forEach((entry) => {
            html += `<tr>
                                          <td class="client-header">${entry}</td>
                                          <td><button class="btn btn-reset" onclick="deleteChauffeur('${entry}')">Suppr. Chauffeur</button></td>
                                          </tr>`;
          });
        }

        container.innerHTML = html + `</tbody></table>`;
        trierDatalist("list-chauffeur");
      }

      function addNewChauffeur() {
        const name = document
          .getElementById("new-config-chauffeur-name")
          .value.trim()
          .toUpperCase();

        if (!name || transportConfigChauffeur[name]) return;

        transportConfigChauffeur[name] = {};
        localStorage.setItem(
          "transport_config_chauffeur",
          JSON.stringify(transportConfigChauffeur),
        );
        document.getElementById("new-config-chauffeur-name").value = "";
        renderConfigUIChauffeur();
      }

      function deleteChauffeur(name) {
        if (confirm("Supprimer ce chauffeur ?")) {
          delete transportConfigChauffeur[name];
          localStorage.setItem(
            "transport_config_chauffeur",
            JSON.stringify(transportConfigChauffeur),
          );
          renderConfigUIChauffeur();
        }
      }

      function updateMatosDatalist() {
        const listVehicule = document.getElementById("list-vehicule");
        if (listVehicule) {
          const uniqueMatos = new Set(defaultMatosList);

          for (let group in transportConfigGroup) {
            Object.keys(transportConfigGroup[group]).forEach((m) =>
              uniqueMatos.add(m),
            );
          }
          for (let associe in transportConfigAssocie) {
            Object.keys(transportConfigAssocie[associe]).forEach((m) =>
              uniqueMatos.add(m),
            );
          }

          listVehicule.innerHTML = "";
          Array.from(uniqueMatos)
            .sort()
            .forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              listVehicule.appendChild(opt);
            });
        }

        const listClient = document.getElementById("list-client");
        if (listClient) {
          listClient.innerHTML = "";
          Object.keys(transportConfigClient)
            .sort()
            .forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c;
              listClient.appendChild(opt);
            });
        }
      }

      updateTelephoneDatalist();
      renderConfigTelephoneUI();

      function addNewTelephone() {
        const clientInput = document.getElementById(
          "new-config-telephone-client",
        );
        const nameInput = document.getElementById("new-config-telephone-name");
        const numInput = document.getElementById("new-config-telephone-number");
        const name = nameInput.value.trim().toUpperCase();
        const client = clientInput.value.trim().toUpperCase();
        const numero = formatPhoneNumber(numInput.value.trim());

        if (name) {
          transportConfigTelephone[name] = { numero: numero, client: client };
          localStorage.setItem(
            "transport_config_telephone",
            JSON.stringify(transportConfigTelephone),
          );

          clientInput.value = "";
          nameInput.value = "";
          numInput.value = "";
          updateTelephoneDatalist();
          renderConfigTelephoneUI();
        }
      }

      function updateTelephoneDatalist() {
        const dl = document.getElementById("list-telephone");
        if (!dl) return;
        dl.innerHTML = "";

        Object.keys(transportConfigTelephone)
          .sort((a, b) => a.localeCompare(b))
          .forEach((name) => {
            const data = transportConfigTelephone[name];
            const opt = document.createElement("option");

            opt.value = name;
            opt.setAttribute("data-numero", data.numero || ""); // On stocke le num√©ro en data attribute

            dl.appendChild(opt);
          });
      }

      function updateClientInConfig(name, newClientName) {
        transportConfigTelephone[name].client = newClientName
          .trim()
          .toUpperCase();
        localStorage.setItem(
          "transport_config_telephone",
          JSON.stringify(transportConfigTelephone),
        );
      }

      function updateNameInConfig(oldName, newName) {
        if (oldName === newName) return;

        transportConfigTelephone[newName] = transportConfigTelephone[oldName];
        delete transportConfigTelephone[oldName];

        localStorage.setItem(
          "transport_config_telephone",
          JSON.stringify(transportConfigTelephone),
        );

        renderConfigTelephoneUI();
        updateTelephoneDatalist();
      }

      function renderConfigTelephoneUI() {
        const container = document.getElementById("config-container-telephone");
        if (!container) return;

        let html = `<table class="config-table" style="width:100%; table-layout: fixed; border-collapse: collapse;">
                            <thead>
                              <tr>
                                <th style="width: 25%;">Client</th>
                                <th style="width: 25%;">Contact</th>
                                <th style="width: 30%;">Num√©ro de T√©l√©phone</th>
                                <th style="width: 20%;">Action</th>
                              </tr>
                            </thead>
                            <tbody>`;

        const contacts = Object.keys(transportConfigTelephone).sort((a, b) => {
          const clientA = transportConfigTelephone[a].client || "";
          const clientB = transportConfigTelephone[b].client || "";
          return clientA.localeCompare(clientB) || a.localeCompare(b);
        });

        if (contacts.length === 0) {
          html += `<tr><td colspan="4" style="text-align:center;"><i>Aucun contact configur√©...</i></td></tr>`;
        } else {
          contacts.forEach((name) => {
            const tel = transportConfigTelephone[name].numero || "";
            const client = transportConfigTelephone[name].client || ""; // On r√©cup√®re le nom du client

            html += `<tr>
                                  <td style="padding: 8px;" contenteditable="true" onblur="updateClientInConfig('${name}', this.innerText)">${client}</td>
                                  <td style="padding: 8px;" contenteditable="true" onblur="updateNameInConfig('${name}', this.innerText)">${name}</td>
                                  <td style="text-align: center;" contenteditable="true" onblur="updateTelInConfig('${name}', this.innerText)">${tel}</td>
                                  <td style="text-align: center;">
                                    <button onclick="deleteTelephone('${name}')" class="btn-delete">Supprimer</button>
                                  </td>
                              </tr>`;
          });
        }
        html += `</tbody></table>`;
        container.innerHTML = html;
      }

      function updateTelInConfig(name, newNum) {
        const formattedNum = formatPhoneNumber(newNum);

        transportConfigTelephone[name].numero = formattedNum;
        localStorage.setItem(
          "transport_config_telephone",
          JSON.stringify(transportConfigTelephone),
        );

        renderConfigTelephoneUI();
        updateTelephoneDatalist();
      }

      function deleteTelephone(name) {
        if (confirm("Supprimer " + name + " ?")) {
          delete transportConfigTelephone[name];
          localStorage.setItem(
            "transport_config_telephone",
            JSON.stringify(transportConfigTelephone),
          );
          updateTelephoneDatalist();
          renderConfigTelephoneUI();
        }
      }

      function formatPhoneNumber(value) {
        const numbers = value.replace(/\D/g, "");
        return numbers.match(/.{1,2}/g)?.join(" ") || numbers;
      }

      function calculerTotal() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[13].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerTotalSupplement_client() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[14].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price-supplement-client").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerTotalIC_client() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[15].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price-IC-client").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerMarge_Client() {
        let totalMarge = 0;
        const rows = document.querySelectorAll("#table-body tr");

        rows.forEach((tr) => {
          // Extraction des valeurs num√©riques des 3 colonnes concern√©es
          const tarif =
            parseFloat(tr.querySelector(".cell-tarif")?.textContent) || 0;
          const supp =
            parseFloat(
              tr.querySelector(".cell-supplement-client")?.textContent,
            ) || 0;
          const ic =
            parseFloat(tr.querySelector(".cell-IC-client")?.textContent) || 0;

          // Somme pour la ligne actuelle
          totalMarge += tarif + supp + ic;
        });

        // Mise √† jour de l'affichage dans le footer (si vous avez un ID d√©di√©)
        const displayMarge = document.getElementById("total-marge-client");
        if (displayMarge) {
          displayMarge.textContent = totalMarge.toFixed(2) + " ‚Ç¨";
        }

        return totalMarge;
      }

      function calculerTotalAffrete() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[16].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price-affrete").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerTotalSupplement_affrete() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[17].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price-supplement-affrete").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerTotalIC_affrete() {
        let total = 0;
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const content = tr.cells[18].textContent
            .replace(/[‚Ç¨\s]/g, "")
            .replace(",", ".");
          const val = parseFloat(content);
          if (!isNaN(val)) total += val;
        });
        document.getElementById("total-price-IC-affrete").textContent =
          total.toFixed(2) + " ‚Ç¨";
      }

      function calculerMarge_Affrete() {
        let totalMarge = 0;
        const rows = document.querySelectorAll("#table-body tr");

        rows.forEach((tr) => {
          // Extraction des valeurs num√©riques des 3 colonnes concern√©es
          const tarif =
            parseFloat(tr.querySelector(".cell-tarif-affrete")?.textContent) ||
            0;
          const supp =
            parseFloat(
              tr.querySelector(".cell-supplement-affrete")?.textContent,
            ) || 0;
          const ic =
            parseFloat(tr.querySelector(".cell-IC-affrete")?.textContent) || 0;

          // Somme pour la ligne actuelle
          totalMarge += tarif + supp + ic;
        });

        // Mise √† jour de l'affichage dans le footer (si vous avez un ID d√©di√©)
        const displayMarge = document.getElementById("total-marge-affrete");
        if (displayMarge) {
          displayMarge.textContent = totalMarge.toFixed(2) + " ‚Ç¨";
        }

        return totalMarge;
      }

      function calculerMargeReelle() {
        const totalClient = calculerMarge_Client();
        const totalAffrete = calculerMarge_Affrete();
        const margeNette = totalClient - totalAffrete;

        const display = document.getElementById("marge-nette");
        if (display) {
          display.textContent = margeNette.toFixed(2) + " ‚Ç¨";
          display.style.color = margeNette >= 0 ? "#28a745" : "#dc3545";
        }
      }

      function rgbToHex(rgb) {
        if (!rgb || rgb === "" || rgb === "transparent") return "";
        if (rgb.startsWith("#")) return rgb;

        const result = rgb.match(/\d+/g);
        if (!result || result.length < 3) return rgb;

        const r = parseInt(result[0]);
        const g = parseInt(result[1]);
        const b = parseInt(result[2]);

        return (
          "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)
        );
      }

      function saveCurrentDay() {
        const date = document.getElementById("current-date-picker").value;
        if (!date) return;

        const rows = [];
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          const dateLigne = tr.cells[4]?.innerText || "";
          const estMemeMois = estMemeMoisQueSelection(dateLigne);

          // R√©cup√©rer le snapshot existant
          let snapshot = null;
          if (tr.dataset.snapshot) {
            snapshot = JSON.parse(tr.dataset.snapshot);
          }

          // üîÑ Si m√™me mois ‚Üí Capturer/mettre √† jour le snapshot
          if (estMemeMois) {
            const client = tr.querySelector(".select-client").value;
            const vehicule = tr.querySelector(".select-vehicule").value;
            const associe = tr.querySelector(".select-associe").value;

            if ((client && vehicule) || (associe && vehicule)) {
              snapshot = captureSnapshot(client, vehicule, associe);
              tr.dataset.snapshot = JSON.stringify(snapshot);
            }
          }
          // üîí Si autre mois ‚Üí On garde le snapshot tel quel

          const cellules = tr.querySelectorAll("td");
          const couleursParCellule = {};

          cellules.forEach((td, index) => {
            if (index === 0) return; // On ignore l'associ√© qui a sa propre couleur

            const bgColor = td.style.backgroundColor;
            if (bgColor && bgColor !== "" && bgColor !== "transparent") {
              // Convertir rgb(255, 238, 0) en #ffee00
              const hexColor = rgbToHex(bgColor);
              if (hexColor) {
                couleursParCellule[index] = hexColor;
              }
            }
          });

          rows.push({
            associe: tr.querySelector(".select-associe").value,
            matin: tr.cells[1].innerText,
            apres: tr.cells[2].innerText,
            chantier: tr.cells[3].innerText,
            date: tr.cells[4].innerText,
            vehicule: tr.querySelector(".select-vehicule").value,
            client: tr.querySelector(".select-client").value,
            telephone:
              tr
                .querySelector(".col-telephone")
                ?.getAttribute("data-telephone-full") ||
              tr.querySelector(".select-telephone")?.value ||
              "",
            consigne: tr.cells[8].innerText,
            chauffeur: tr.querySelector(".select-chauffeur").value,
            n_commande: tr.cells[10].innerText,
            n_chantier: tr.cells[11].innerText,
            n_bon: tr.cells[12].innerText,
            tarif: tr.cells[13].innerText,
            supplement_client: tr.cells[14].innerText,
            IC_client: tr.cells[15].innerText,
            tarif_affrete: tr.cells[16].innerText,
            supplement_affrete: tr.cells[17].innerText,
            IC_affrete: tr.cells[18].innerText,
            commentaire: tr.cells[19].innerText,

            // ‚úÖ AJOUT : Sauvegarde du snapshot
            snapshot: snapshot,
            couleurs_cellules:
              Object.keys(couleursParCellule).length > 0
                ? couleursParCellule
                : null,
          });
        });

        localStorage.setItem("planning_" + date, JSON.stringify(rows));
        calculerTousLesTotaux();
      }

      function appliquerCouleurAssocie(input) {
        const cell = input.parentElement;
        cell.className = "matos-cell"; // Reset les classes
        const val = input.value.toUpperCase();

        if (val) {
          const baseAssocies = ["LANDAIS", "ALLARD", "STD"];

          if (baseAssocies.includes(val)) {
            // C'est un des 3 de base : on met la classe sp√©cifique (ex: color-landais)
            cell.classList.add("color-" + val.toLowerCase());
          } else {
            // C'est un nouvel affr√©t√© : on met la couleur grise
            // Tu peux soit cr√©er une classe .color-affrete dans ton CSS
            // Soit l'appliquer directement ici :
            cell.style.backgroundColor = "#e9ecef";
            cell.style.color = "#000"; // Texte noir pour la lisibilit√©
          }
        } else {
          // Si la case est vide, on enl√®ve la couleur directe au cas o√π
          cell.style.backgroundColor = "";
        }
      }

      function verifierDoublon(inputModifie) {
        const nomSaisi = inputModifie.value.trim();
        if (nomSaisi === "") return;

        const toutesLesLignes = document.querySelectorAll("#table-body tr");
        let existeDeja = false;

        toutesLesLignes.forEach((tr) => {
          const inputChauffeur = tr.querySelector(".select-chauffeur");
          // On compare avec les autres lignes uniquement
          if (inputChauffeur && inputChauffeur !== inputModifie) {
            if (inputChauffeur.value.trim() === nomSaisi) {
              existeDeja = true;
            }
          }
        });

        if (existeDeja) {
          if (
            !confirm(
              `ATTENTION : ${nomSaisi} est d√©j√† sur le planning.\n\nVoulez-vous quand m√™me l'ajouter ?`,
            )
          ) {
            inputModifie.value = "";
            saveCurrentDay();
          }
        }
      }

      function supprimerLigne(btn) {
        const tableBody = document.getElementById("table-body");

        // 1. On demande confirmation
        if (confirm("Voulez-vous vraiment supprimer cette ligne ?")) {
          // 2. On supprime la ligne
          btn.closest("tr").remove();

          // 3. SI c'√©tait la derni√®re ligne, on en rajoute une vide
          if (tableBody.querySelectorAll("tr").length === 0) {
            ajouterLigne(); // Appelle ta fonction existante pour recr√©er une ligne
          }

          // 4. On met √† jour les donn√©es et les totaux
          saveCurrentDay();
          calculerTousLesTotaux();
        }
      }
      /**
       * @param {string} dateStr - Date au format DD/MM/YY (ex: "28/01/26")
       * @returns {boolean}
       */
      function estMemeMoisQueSelection(dateStr) {
        if (!dateStr) return false;

        const dateSelectionnee = document.getElementById(
          "current-date-picker",
        ).value;
        if (!dateSelectionnee) return false;

        // Convertir la date de la ligne "28/01/26" en "2026-01"
        const parties = dateStr.split("/");
        if (parties.length !== 3) return false;
        const moisLigne = `20${parties[2]}-${parties[1]}`; // "2026-01"

        // Extraire le mois de la date s√©lectionn√©e "2026-01-28" ‚Üí "2026-01"
        const moisSelectionne = dateSelectionnee.substring(0, 7); // "2026-01"

        return moisLigne === moisSelectionne;
      }

      function captureSnapshot(client, vehicule, associe) {
        const snapshot = {
          tarif_client_snapshot: 0,
          indice_client_snapshot: 0,
          tarif_affrete_snapshot: 0,
          indice_affrete_snapshot: 0,
          date_capture: new Date().toISOString(),
        };

        // Capture tarif client
        if (client && vehicule) {
          const groupeNom = transportConfigClient[client];
          if (
            groupeNom &&
            transportConfigGroup[groupeNom] &&
            transportConfigGroup[groupeNom][vehicule]
          ) {
            snapshot.tarif_client_snapshot =
              parseFloat(transportConfigGroup[groupeNom][vehicule].tarif) || 0;

            // Indice client
            let indice =
              parseFloat(transportConfigGroup[groupeNom][vehicule].indice) || 0;
            if (indice === 0) {
              const cat = transportConfigMateriel[vehicule];
              if (
                cat &&
                transportConfigGroupInfo[groupeNom] &&
                transportConfigGroupInfo[groupeNom][cat]
              ) {
                indice =
                  parseFloat(transportConfigGroupInfo[groupeNom][cat]) || 0;
              }
            }
            snapshot.indice_client_snapshot = indice;
          }
        }

        // Capture tarif affr√©t√©
        if (associe && vehicule) {
          if (
            transportConfigAssocie[associe] &&
            transportConfigAssocie[associe][vehicule]
          ) {
            snapshot.tarif_affrete_snapshot =
              parseFloat(transportConfigAssocie[associe][vehicule].tarif) || 0;

            // Indice affr√©t√©
            let indice =
              parseFloat(transportConfigAssocie[associe][vehicule].indice) || 0;
            if (indice === 0) {
              const cat = transportConfigMateriel[vehicule];
              if (
                cat &&
                transportConfigGroupInfo[associe] &&
                transportConfigGroupInfo[associe][cat]
              ) {
                indice =
                  parseFloat(transportConfigGroupInfo[associe][cat]) || 0;
              }
            }
            snapshot.indice_affrete_snapshot = indice;
          }
        }

        return snapshot;
      }

      /**
       * Applique les tarifs depuis un snapshot vers une ligne
       * @param {HTMLElement} tr - Ligne du tableau
       * @param {Object} snapshot - Snapshot contenant les tarifs
       */
      function applySnapshotToRow(tr, snapshot) {
        if (!snapshot) return;

        const cellTarifClient = tr.querySelector(".cell-tarif");
        const cellTarifAffrete = tr.querySelector(".cell-tarif-affrete");
        const cellICClient = tr.querySelector(".cell-IC-client");
        const cellICAffrete = tr.querySelector(".cell-IC-affrete");

        // Application tarif client
        if (snapshot.tarif_client_snapshot !== undefined) {
          const tarifC = snapshot.tarif_client_snapshot;
          const indiceC = snapshot.indice_client_snapshot || 0;
          const icC = tarifC * (indiceC / 100);

          cellTarifClient.textContent = tarifC.toFixed(2) + " ‚Ç¨";
          cellICClient.textContent = icC.toFixed(2) + " ‚Ç¨";
          cellICClient.style.color =
            icC > 0 ? "#28a745" : icC < 0 ? "#dc3545" : "#95a5a6";
          cellICClient.style.fontWeight = icC !== 0 ? "bold" : "normal";
        }

        // Application tarif affr√©t√©
        if (snapshot.tarif_affrete_snapshot !== undefined) {
          const tarifA = snapshot.tarif_affrete_snapshot;
          const indiceA = snapshot.indice_affrete_snapshot || 0;
          const icA = tarifA * (indiceA / 100);

          cellTarifAffrete.textContent = tarifA.toFixed(2) + " ‚Ç¨";
          cellICAffrete.textContent = icA.toFixed(2) + " ‚Ç¨";
          cellICAffrete.style.color =
            icA > 0 ? "#28a745" : icA < 0 ? "#dc3545" : "#95a5a6";
          cellICAffrete.style.fontWeight = icA !== 0 ? "bold" : "normal";
        }
      }

      /**
       * Extrait le nom du contact depuis la valeur compl√®te "NOM - 06 12 34 56 78"
       */
      function extractContactName(fullValue) {
        if (!fullValue) return "";

        // Si le format contient " - ", on prend la partie avant
        if (fullValue.includes(" - ")) {
          return fullValue.split(" - ")[0].trim();
        }

        // Sinon on retourne tel quel
        return fullValue;
      }

      /**
       * Extrait le num√©ro depuis la valeur compl√®te "NOM - 06 12 34 56 78"
       */
      function extractPhoneNumber(fullValue) {
        if (!fullValue) return "";

        // Si le format contient " - ", on prend la partie apr√®s
        if (fullValue.includes(" - ")) {
          const parts = fullValue.split(" - ");
          return parts[1] ? parts[1].trim() : "";
        }

        // Sinon on cherche dans transportConfigTelephone
        const contactName = fullValue.trim();
        if (transportConfigTelephone[contactName]) {
          return transportConfigTelephone[contactName].numero || "";
        }

        return "";
      }

      function displayTelephoneInCell(td, fullValue) {
        const contactName = extractContactName(fullValue);

        if (!contactName) {
          td.innerHTML = `<input class="combo-input select-telephone" list="list-telephone" value="" placeholder="Contact...">`;
          return;
        }

        // ‚úÖ Chercher le num√©ro directement dans la config
        let phoneNumber = "";
        if (transportConfigTelephone[contactName]) {
          phoneNumber = transportConfigTelephone[contactName].numero || "";
        } else if (fullValue.includes(" - ")) {
          // Si fullValue contient d√©j√† le num√©ro (format "NOM - NUMERO")
          phoneNumber = extractPhoneNumber(fullValue);
        }

        // ‚úÖ Affichage sur deux lignes avec le num√©ro en dessous
        td.innerHTML = `
              <div class="telephone-wrapper">
                <input class="combo-input select-telephone" list="list-telephone" value="${contactName}" placeholder="Contact...">
                ${phoneNumber ? `<div class="telephone-number">${phoneNumber}</div>` : ""}
              </div>
            `;
      }

      function ajouterLigne(data = null) {
        const tableBody = document.getElementById("table-body");
        const datePicker = document.getElementById("current-date-picker");
        const dateSelectionnee = new Date(datePicker.value);
        const dateFormatee = dateSelectionnee.toLocaleDateString("fr-FR", {
          day: "2-digit",
          month: "2-digit",
          year: "2-digit",
        });

        const tr = document.createElement("tr");

        tr.style.backgroundColor = "";
        tr.removeAttribute("style");

        const getPlaceholderClass = (val, defaultText) => {
          return !val || val === defaultText ? "placeholder-style" : "";
        };

        const valChantier = data ? data.chantier : "Chantier...";
        const valConsigne = data ? data.consigne : "Consigne...";
        const valCommande = data ? data.n_commande : "N¬∞ Commande...";
        const valChantierNum = data ? data.n_chantier : "N¬∞ Chantier...";
        const valBon = data ? data.n_bon : "N¬∞ Bon...";
        const valComm = data ? data.commentaire : "Commentaire...";

        tr.innerHTML = `
                <td class="matos-cell">
                    <input class="combo-input select-associe" list="list-associe" value="${data ? data.associe : ""}" placeholder="Associ√©...">
                </td>
                <td contenteditable="true">${data ? data.matin : "0.5"}</td>
                <td contenteditable="true">${data ? data.apres : "0.5"}</td>

                <td contenteditable="true" class="${getPlaceholderClass(valChantier, "Chantier...")}">${valChantier}</td>

                <td contenteditable="true">${data && data.date && data.date.includes("/20") ? data.date.replace("/20", "/") : data ? data.date : dateFormatee}</td>

                <td class="matos-cell">
                    <input class="combo-input select-vehicule" list="list-vehicule" value="${data ? data.vehicule : ""}" placeholder="V√©hicule...">
                </td>
                <td class="matos-cell">
                    <input class="combo-input select-client" list="list-client" value="${data ? data.client : ""}" placeholder="Client...">
                </td>

                <td class="matos-cell col-telephone" data-telephone-full="${data ? data.telephone : ""}">
                    <input class="combo-input select-telephone" list="list-telephone" value="${data ? extractContactName(data.telephone) : ""}" placeholder="Contact...">
                </td>

                <td contenteditable="true" class="col-consigne ${getPlaceholderClass(valConsigne, "Consigne...")}">${valConsigne}</td>

                <td class="matos-cell">
                    <input class="combo-input select-chauffeur" list="list-chauffeur" value="${data ? data.chauffeur : ""}" placeholder="Chauffeur...">
                </td>

                <td contenteditable="true" class="${getPlaceholderClass(valCommande, "N¬∞ Commande...")}">${valCommande}</td>
                <td contenteditable="true" class="${getPlaceholderClass(valChantierNum, "N¬∞ Chantier...")}">${valChantierNum}</td>
                <td contenteditable="true" class="cell-bon ${getPlaceholderClass(valBon, "N¬∞ Bon...")}">${valBon}</td>

                <td class="cell-tarif" contenteditable="true" style="padding:4px">${data && data.tarif ? data.tarif : "0.00 ‚Ç¨"}</td>
                <td class="cell-supplement-client" contenteditable="true" style="padding:4px">${data && data.supplement_client ? data.supplement_client : "0.00 ‚Ç¨"}</td>
                <td class="cell-IC-client" contenteditable="true" style="padding:4px">${data && data.IC_client ? data.IC_client : "0.00 ‚Ç¨"}</td>
                <td class="cell-tarif-affrete" contenteditable="true" style="padding:4px">${data && data.tarif_affrete ? data.tarif_affrete : "0.00 ‚Ç¨"}</td>
                <td class="cell-supplement-affrete" contenteditable="true" style="padding:4px">${data && data.supplement_affrete ? data.supplement_affrete : "0.00 ‚Ç¨"}</td>
                <td class="cell-IC-affrete" contenteditable="true" style="padding:4px">${data && data.IC_affrete ? data.IC_affrete : "0.00 ‚Ç¨"}</td>

                <td contenteditable="true" class="${getPlaceholderClass(valComm, "Commentaire...")}">${valComm}</td>
                <td class="hide-export" style="text-align:center; white-space:nowrap;">
                    <button style="color:red; background:none; border:none; cursor:pointer; font-size:16px;" onclick="if(confirm('Supprimer ?')){this.closest('tr').remove(); saveCurrentDay(); calculerTousLesTotaux();}">√ó</button>
                    <button style="color:orange; background:none; border:none; cursor:pointer; font-size:16px;" onclick="dupliquerLigne(this)">üìë</button>
                </td>
            `;

        tr.querySelectorAll('[contenteditable="true"]').forEach((cell) => {
          cell.addEventListener("input", () => {
            if (
              cell.classList.contains("cell-tarif") ||
              cell.classList.contains("cell-tarif-affrete")
            ) {
              updateRowTarif(tr);
            }
            if (cell.classList.contains("cell-bon")) {
              updateRowHighlight(tr);
            }
            saveCurrentDay();
          });

          cell.addEventListener("blur", () => {
            const contenuSaisi = cell.textContent.trim();
            const placeholders = [
              "Chantier...",
              "Consigne...",
              "N¬∞ Commande...",
              "N¬∞ Chantier...",
              "N¬∞ Bon...",
              "Commentaire...",
            ];

            // --- LOGIQUE NOUVELLE LIGNE AU D√âCLIC ---
            const estDerniereLigne = !tr.nextElementSibling;
            // On cr√©e la ligne si c'est la derni√®re et qu'on a tap√© quelque chose de r√©el
            if (
              estDerniereLigne &&
              contenuSaisi !== "" &&
              !placeholders.includes(contenuSaisi)
            ) {
              ajouterLigne();
            }
            // ----------------------------------------

            const isNumericCell =
              cell.classList.contains("cell-tarif") ||
              cell.classList.contains("cell-tarif-affrete") ||
              cell.classList.contains("cell-supplement-client") ||
              cell.classList.contains("cell-supplement-affrete") ||
              cell.classList.contains("cell-IC-client") ||
              cell.classList.contains("cell-IC-affrete");

            if (isNumericCell) {
              let val = parseFloat(contenuSaisi.replace(",", ".")) || 0;
              cell.textContent = val.toFixed(2) + " ‚Ç¨";
              calculerTousLesTotaux();
            } else if (contenuSaisi === "") {
              const index = cell.cellIndex;
              const map = {
                3: "Chantier...",
                8: "Consigne...",
                10: "N¬∞ Commande...",
                11: "N¬∞ Chantier...",
                12: "N¬∞ Bon...",
                19: "Commentaire...",
              };
              if (map[index]) {
                cell.textContent = map[index];
                cell.classList.add("placeholder-style");
              }
            }
            saveCurrentDay();
          });

          cell.addEventListener("focus", () => {
            const placeholders = [
              "Chantier...",
              "Consigne...",
              "N¬∞ Commande...",
              "N¬∞ Chantier...",
              "N¬∞ Bon...",
              "Commentaire...",
            ];
            const isNumericCell =
              cell.classList.contains("cell-tarif") ||
              cell.classList.contains("cell-tarif-affrete") ||
              cell.classList.contains("cell-supplement-client") ||
              cell.classList.contains("cell-supplement-affrete") ||
              cell.classList.contains("cell-IC-client") ||
              cell.classList.contains("cell-IC-affrete");

            if (!isNumericCell) {
              if (placeholders.includes(cell.textContent.trim())) {
                cell.textContent = "";
                cell.classList.remove("placeholder-style");
              }
            } else {
              // Si c'est du num√©rique, on enl√®ve le "‚Ç¨" pour √©diter facilement
              let val = cell.textContent.replace(" ‚Ç¨", "").trim();
              if (val === "0.00") cell.textContent = "";
              else cell.textContent = val;
            }
          });
        });

        tr.querySelectorAll(".combo-input").forEach((input) => {
          input.addEventListener("change", () => {
            const estDerniereLigne = !tr.nextElementSibling;
            if (estDerniereLigne && input.value.trim() !== "") {
              ajouterLigne();
            }

            if (input.classList.contains("select-vehicule")) {
              const vehicule = input.value.trim();

              if (!vehicule) {
                tr.querySelector(".cell-tarif").textContent = "0.00 ‚Ç¨";
                tr.querySelector(".cell-IC-client").textContent = "0.00 ‚Ç¨";
                tr.querySelector(".cell-tarif-affrete").textContent = "0.00 ‚Ç¨";
                tr.querySelector(".cell-IC-affrete").textContent = "0.00 ‚Ç¨";

                delete tr.dataset.snapshot; // Supprimer le snapshot si v√©hicule vid√©

                saveCurrentDay();
                calculerTousLesTotaux();
                return;
              }
            }

            if (input.classList.contains("select-telephone")) {
              const td = input.closest("td");
              const contactName = input.value.trim();

              // ‚úÖ Chercher le num√©ro correspondant dans la config
              if (transportConfigTelephone[contactName]) {
                const phoneNumber =
                  transportConfigTelephone[contactName].numero || "";

                // Stocker la valeur compl√®te dans l'attribut data
                const fullValue = phoneNumber
                  ? `${contactName} - ${phoneNumber}`
                  : contactName;
                td.setAttribute("data-telephone-full", fullValue);

                // ‚úÖ R√âAFFICHER POUR METTRE √Ä JOUR LE NUM√âRO
                displayTelephoneInCell(td, fullValue);

                // ‚úÖ IMPORTANT : R√©attacher l'event listener sur le nouvel input cr√©√©
                const newInput = td.querySelector(".select-telephone");
                if (newInput) {
                  newInput.addEventListener("change", () => {
                    const newContactName = newInput.value.trim();
                    if (transportConfigTelephone[newContactName]) {
                      const newPhoneNumber =
                        transportConfigTelephone[newContactName].numero || "";
                      const newFullValue = newPhoneNumber
                        ? `${newContactName} - ${newPhoneNumber}`
                        : newContactName;
                      td.setAttribute("data-telephone-full", newFullValue);
                      displayTelephoneInCell(td, newFullValue);
                    }
                    saveCurrentDay();
                  });
                }
              } else {
                // ‚úÖ Si le contact n'existe pas, on efface juste le num√©ro
                td.setAttribute("data-telephone-full", contactName);
                displayTelephoneInCell(td, contactName);
              }
            }

            // ‚úÖ AJOUT : Capturer le snapshot quand on modifie client/v√©hicule/associ√©
            if (
              input.classList.contains("select-client") ||
              input.classList.contains("select-vehicule") ||
              input.classList.contains("select-associe")
            ) {
              const client = tr.querySelector(".select-client").value;
              const vehicule = tr.querySelector(".select-vehicule").value;
              const associe = tr.querySelector(".select-associe").value;

              // Si on a au minimum un client ET un v√©hicule, on capture
              if (vehicule && ((client && vehicule) || (associe && vehicule))) {
                const snapshot = captureSnapshot(client, vehicule, associe);
                tr.dataset.snapshot = JSON.stringify(snapshot);

                // Appliquer imm√©diatement le snapshot
                applySnapshotToRow(tr, snapshot);
              }
            }

            saveCurrentDay();

            if (input.classList.contains("select-associe")) {
              appliquerCouleurAssocie(input);
            }
          });
          if (input.classList.contains("select-associe")) {
            input.addEventListener("blur", () => {
              trierPlanningParAssocie();
            });
          }
        });

        tableBody.appendChild(tr);

        const inputAssocie = tr.querySelector(".select-associe");
        const cells = tr.querySelectorAll("td"); // On r√©cup√®re toutes les cellules

        if (data) {
          appliquerCouleurAssocie(inputAssocie);

          if (data.couleur) {
            tr.style.backgroundColor = data.couleur;
            cells.forEach((td) => {
              if (!td.classList.contains("matos-cell")) {
                td.style.backgroundColor = data.couleur;
              }
            });
          }
          // ‚úÖ AJOUT : Restaurer le snapshot s'il existe
          if (data.snapshot) {
            tr.dataset.snapshot = JSON.stringify(data.snapshot);
          }
          if (data.telephone) {
            const telTd = tr.querySelector(".col-telephone");
            if (telTd) {
              displayTelephoneInCell(telTd, data.telephone);

              // ‚úÖ R√©attacher l'event listener sur le nouvel input
              const newInput = telTd.querySelector(".select-telephone");
              if (newInput) {
                newInput.addEventListener("change", () => {
                  const contactName = newInput.value.trim();
                  if (transportConfigTelephone[contactName]) {
                    const phoneNumber =
                      transportConfigTelephone[contactName].numero || "";
                    const fullValue = phoneNumber
                      ? `${contactName} - ${phoneNumber}`
                      : contactName;
                    telTd.setAttribute("data-telephone-full", fullValue);
                    displayTelephoneInCell(telTd, fullValue);
                  }
                  saveCurrentDay();
                });
              }
            }
          }
        } else {
          tr.style.backgroundColor = "";
          tr.removeAttribute("style");

          cells.forEach((td) => {
            td.style.backgroundColor = "";
            td.style.color = "";
          });

          appliquerCouleurAssocie(inputAssocie);
        }

        calculerTousLesTotaux();
        updateRowHighlight(tr);
        filterTable();
        trierPlanningParAssocie();

        setTimeout(() => {
          updateRowTarif(tr);
        }, 50);
      }

      /**
       * Force le recalcul de tous les tarifs du planning actuel
       */
      function forceRecalculTousLesTarifs() {
        const rows = document.querySelectorAll("#table-body tr");
        rows.forEach((tr) => {
          updateRowTarif(tr);
        });
        calculerTousLesTotaux();
      }

      /**
       * Force le recalcul de tous les tarifs du planning actuel
       */
      function forceRecalculTousLesTarifs() {
        const rows = document.querySelectorAll("#table-body tr");
        rows.forEach((tr) => {
          updateRowTarif(tr);
        });
        calculerTousLesTotaux();
      }

      function calculerTousLesTotaux() {
        if (typeof calculerTotal === "function") calculerTotal();
        if (typeof calculerTotalSupplement_client === "function")
          calculerTotalSupplement_client();
        if (typeof calculerTotalIC_client === "function")
          calculerTotalIC_client();
        if (typeof calculerTotalAffrete === "function") calculerTotalAffrete();
        if (typeof calculerTotalSupplement_affrete === "function")
          calculerTotalSupplement_affrete();
        if (typeof calculerTotalIC_affrete === "function")
          calculerTotalIC_affrete();

        // 2. Calculer les Totaux G√©n√©raux (Marge Client et Co√ªt Affr√©t√©)
        const totalCA = calculerMarge_Client();
        const totalCout = calculerMarge_Affrete();

        // 3. Calculer la Marge Nette (B√©n√©fice)
        const margeNette = totalCA - totalCout;
        const displayMarge = document.getElementById("marge-nette");

        if (displayMarge) {
          displayMarge.textContent = margeNette.toFixed(2) + " ‚Ç¨";
          // Devient rouge si la marge est n√©gative, vert si positive
          displayMarge.style.color = margeNette >= 0 ? "#28a745" : "#dc3545";
        }
      }

      function dupliquerLigne(bouton) {
        const ligne = bouton.closest("tr");

        const data = {
          associe: ligne.querySelector(".select-associe").value,
          matin: ligne.cells[1].innerText,
          apres: ligne.cells[2].innerText,
          chantier: ligne.cells[3].innerText,
          date: ligne.cells[4].innerText,
          vehicule: ligne.querySelector(".select-vehicule").value,
          client: ligne.querySelector(".select-client").value,
          telephone: ligne.querySelector(".select-telephone").value,
          consigne: ligne.cells[8].innerText,
          chauffeur: ligne.querySelector(".select-chauffeur").value,
          n_commande: ligne.cells[10].innerText,
          n_chantier: ligne.cells[11].innerText,
          n_bon: ligne.cells[12].innerText,
          tarif: ligne.cells[13].innerText,
          supplement_client: ligne.cells[14].innerText,
          IC_client: ligne.cells[15].innerText,
          tarif_affrete: ligne.cells[16].innerText,
          supplement_affrete: ligne.cells[17].innerText,
          IC_affrete: ligne.cells[18].innerText,
          commentaire: ligne.cells[19].innerText,
        };

        ajouterLigne(data);
        const tableBody = document.getElementById("table-body");
        const nouvelleLigne = tableBody.lastElementChild;

        updateRowTarif(nouvelleLigne);
        calculerTousLesTotaux();
        saveCurrentDay();
      }

      function copierJournee() {
        const rows = [];
        document.querySelectorAll("#table-body tr").forEach((tr) => {
          rows.push({
            associe: tr.querySelector(".select-associe").value,
            matin: tr.cells[1].innerText,
            apres: tr.cells[2].innerText,
            chantier: tr.cells[3].innerText,
            date: tr.cells[4].innerText,
            vehicule: tr.querySelector(".select-vehicule").value,
            client: tr.querySelector(".select-client").value,
            telephone: tr.querySelector(".select-telephone").value,
            consigne: tr.cells[8].innerText,
            chauffeur: tr.querySelector(".select-chauffeur").value,
            n_commande: tr.cells[10].innerText,
            n_chantier: tr.cells[11].innerText,
            n_bon: tr.cells[12].innerText,
            tarif: tr.cells[13].innerText,
            supplement_client: tr.cells[14].innerText,
            IC_client: tr.cells[15].innerText,
            tarif_affrete: tr.cells[16].innerText,
            supplement_affrete: tr.cells[17].innerText,
            IC_affrete: tr.cells[18].innerText,
            commentaire: tr.cells[19].innerText,
          });
        });

        if (rows.length === 0) return;

        localStorage.setItem("planning_copy_buffer", JSON.stringify(rows));
        afficherNotification("Journ√©e copi√©e", "#2196F3");
      }

      function collerJournee() {
        const buffer = localStorage.getItem("planning_copy_buffer");
        if (!buffer) {
          alert("Aucune journ√©e copi√©e.");
          return;
        }

        if (!confirm("Remplacer la journ√©e actuelle par celle copi√©e ?"))
          return;

        const data = JSON.parse(buffer);
        const tableBody = document.getElementById("table-body");
        tableBody.innerHTML = "";

        const datePicker = document.getElementById("current-date-picker");
        const dateFormatee = new Date(datePicker.value).toLocaleDateString(
          "fr-FR",
        );

        data.forEach((row) => {
          row.date = dateFormatee;
          ajouterLigne(row);
        });

        saveCurrentDay();
        afficherNotification("Journ√©e coll√©e", "#2196F3");
      }

      /**
       * D√©tecte si les donn√©es du localStorage sont corrompues ou incompatibles
       */
      function verifierIntegriteDonnees() {
        console.log("üîç V√©rification de l'int√©grit√© des donn√©es...");

        let problemesDetectes = [];

        // 1. V√©rifier la structure des groupes
        try {
          const groups = JSON.parse(
            localStorage.getItem("transport_config_group") || "{}",
          );
          for (let groupName in groups) {
            for (let matos in groups[groupName]) {
              const val = groups[groupName][matos];
              // V√©rifier si c'est bien un objet avec tarif et indice
              if (
                typeof val !== "object" ||
                val === null ||
                !("tarif" in val) ||
                !("indice" in val)
              ) {
                problemesDetectes.push(
                  `Groupe ${groupName} / ${matos} : structure invalide`,
                );
              }
            }
          }
        } catch (e) {
          problemesDetectes.push("transport_config_group corrompu");
        }

        // 2. V√©rifier la structure des associ√©s
        try {
          const associes = JSON.parse(
            localStorage.getItem("transport_config_associe") || "{}",
          );
          for (let associeName in associes) {
            for (let matos in associes[associeName]) {
              const val = associes[associeName][matos];
              if (
                typeof val !== "object" ||
                val === null ||
                !("tarif" in val) ||
                !("indice" in val)
              ) {
                problemesDetectes.push(
                  `Associ√© ${associeName} / ${matos} : structure invalide`,
                );
              }
            }
          }
        } catch (e) {
          problemesDetectes.push("transport_config_associe corrompu");
        }

        // 3. V√©rifier les snapshots dans les plannings
        try {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("planning_")) {
              const planning = JSON.parse(localStorage.getItem(key));
              planning.forEach((row, index) => {
                if (row.snapshot && typeof row.snapshot === "string") {
                  problemesDetectes.push(
                    `${key} ligne ${index} : snapshot en string au lieu d'objet`,
                  );
                }
              });
            }
          }
        } catch (e) {
          problemesDetectes.push("Plannings corrompus");
        }

        return problemesDetectes;
      }

      /**
       * R√©pare automatiquement les donn√©es corrompues
       */
      function reparerDonneesAutomatiquement() {
        console.log("üîß R√©paration automatique des donn√©es...");

        let reparations = 0;

        // 1. R√©parer transport_config_group
        try {
          const groups = JSON.parse(
            localStorage.getItem("transport_config_group") || "{}",
          );
          let modifie = false;

          for (let groupName in groups) {
            for (let matos in groups[groupName]) {
              const val = groups[groupName][matos];
              // Si ce n'est pas un objet avec la bonne structure
              if (
                typeof val !== "object" ||
                val === null ||
                !("tarif" in val) ||
                !("indice" in val)
              ) {
                // Convertir en bonne structure
                const oldValue = typeof val === "number" ? val : 0;
                groups[groupName][matos] = { tarif: oldValue, indice: 0 };
                modifie = true;
                reparations++;
              }
            }
          }

          if (modifie) {
            localStorage.setItem(
              "transport_config_group",
              JSON.stringify(groups),
            );
            console.log("‚úÖ transport_config_group r√©par√©");
          }
        } catch (e) {
          console.error("‚ùå Impossible de r√©parer transport_config_group", e);
        }

        // 2. R√©parer transport_config_associe
        try {
          const associes = JSON.parse(
            localStorage.getItem("transport_config_associe") || "{}",
          );
          let modifie = false;

          for (let associeName in associes) {
            for (let matos in associes[associeName]) {
              const val = associes[associeName][matos];
              if (
                typeof val !== "object" ||
                val === null ||
                !("tarif" in val) ||
                !("indice" in val)
              ) {
                const oldValue = typeof val === "number" ? val : 0;
                associes[associeName][matos] = { tarif: oldValue, indice: 0 };
                modifie = true;
                reparations++;
              }
            }
          }

          if (modifie) {
            localStorage.setItem(
              "transport_config_associe",
              JSON.stringify(associes),
            );
            console.log("‚úÖ transport_config_associe r√©par√©");
          }
        } catch (e) {
          console.error("‚ùå Impossible de r√©parer transport_config_associe", e);
        }

        // 3. R√©g√©n√©rer TOUS les snapshots des plannings
        try {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("planning_")) {
              const planning = JSON.parse(localStorage.getItem(key));
              let modifie = false;

              planning.forEach((row) => {
                // R√©g√©n√©rer le snapshot si n√©cessaire
                if (
                  (row.client && row.vehicule) ||
                  (row.associe && row.vehicule)
                ) {
                  const newSnapshot = captureSnapshot(
                    row.client,
                    row.vehicule,
                    row.associe,
                  );
                  if (
                    JSON.stringify(row.snapshot) !== JSON.stringify(newSnapshot)
                  ) {
                    row.snapshot = newSnapshot;
                    modifie = true;
                    reparations++;
                  }
                }
              });

              if (modifie) {
                localStorage.setItem(key, JSON.stringify(planning));
              }
            }
          }
          console.log("‚úÖ Snapshots des plannings r√©g√©n√©r√©s");
        } catch (e) {
          console.error("‚ùå Impossible de r√©parer les snapshots", e);
        }

        return reparations;
      }

      /**
       * Syst√®me de v√©rification et r√©paration automatique
       */
      function verifierEtReparerSiNecessaire() {
        const problemes = verifierIntegriteDonnees();

        if (problemes.length > 0) {
          console.warn(
            "‚ö†Ô∏è Probl√®mes d√©tect√©s dans le localStorage :",
            problemes,
          );

          // Marquer qu'on a d√©tect√© des probl√®mes
          const derniereReparation = localStorage.getItem(
            "derniere_reparation",
          );
          const maintenant = Date.now();

          // Ne r√©parer qu'une fois par jour pour √©viter les boucles infinies
          if (
            !derniereReparation ||
            maintenant - parseInt(derniereReparation) > 86400000
          ) {
            const reparations = reparerDonneesAutomatiquement();

            if (reparations > 0) {
              localStorage.setItem(
                "derniere_reparation",
                maintenant.toString(),
              );
              console.log(
                `‚úÖ ${reparations} r√©parations effectu√©es avec succ√®s`,
              );

              // Afficher une notification √† l'utilisateur
              setTimeout(() => {
                const notif = document.getElementById("save-notif2");
                if (notif) {
                  notif.innerText = `üîß Donn√©es r√©par√©es automatiquement\n${reparations} probl√®me(s) corrig√©(s)`;
                  notif.style.backgroundColor = "#2196F3";
                  notif.classList.add("notif-visible");

                  setTimeout(() => {
                    notif.classList.remove("notif-visible");
                  }, 3000);
                }
              }, 1000);
            }
          }
        } else {
          console.log("‚úÖ Donn√©es int√®gres");
        }
      }

      function reparerDonneesManuellement() {
        if (
          confirm(
            "R√©parer automatiquement les donn√©es corrompues ?\n\n(Vos donn√©es seront pr√©serv√©es)",
          )
        ) {
          const problemes = verifierIntegriteDonnees();

          if (problemes.length === 0) {
            alert("‚úÖ Aucun probl√®me d√©tect√© !");
            return;
          }

          const reparations = reparerDonneesAutomatiquement();

          alert(
            `‚úÖ R√©paration termin√©e !\n\n${reparations} probl√®me(s) corrig√©(s).`,
          );

          // Recharger la page pour appliquer les corrections
          location.reload();
        }
      }

      function chargerCouleursDate(date) {
        const allSavedColors = JSON.parse(
          localStorage.getItem("planningColors") || "{}",
        );

        const savedColors = allSavedColors[date] || {};
        const rows = document.querySelectorAll("#table-body tr");

        rows.forEach((row) => {
          const rowId = row.innerText.trim().split("\t")[0] + row.rowIndex;
          const data = savedColors[rowId];

          if (data) {
            const cells = row.querySelectorAll("td");

            if (typeof data === "object" && data.type === "partial") {
              // Jaune partiel
              Object.keys(data.cells).forEach((index) => {
                if (cells[index]) {
                  cells[index].style.backgroundColor = data.cells[index];
                }
              });
            } else {
              // Couleur pleine ligne
              cells.forEach((td, index) => {
                const hasSpecificColor =
                  td.style.backgroundColor !== "" &&
                  td.style.backgroundColor !== "transparent";
                if (index === 0 && hasSpecificColor) return;
                td.style.backgroundColor = data;
              });
            }
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        verifierEtReparerSiNecessaire();
        const datePicker = document.getElementById("current-date-picker");
        const displayDate = document.getElementById("display-date");

        const aujourdhui = new Date().toISOString().split("T")[0];
        datePicker.value = aujourdhui;
        displayDate.textContent =
          "Planning du " + new Date(aujourdhui).toLocaleDateString("fr-FR");

        updateMatosDatalist();
        trierDatalist("list-associe");
        trierDatalist("list-chauffeur");
        renderConfigUI();
        renderConfigUI2();
        renderConfigUIChauffeur();
        renderConfigTelephoneUI();

        const saved = localStorage.getItem("planning_" + aujourdhui);
        if (saved && JSON.parse(saved).length > 0) {
          JSON.parse(saved).forEach(ajouterLigne);
          setTimeout(() => {
            forceRecalculTousLesTarifs();
          }, 100);
        } else {
          ajouterLigne();
        }

        datePicker.addEventListener("change", function () {
          const nouvelleDate = this.value;
          displayDate.textContent =
            "Planning du " + new Date(nouvelleDate).toLocaleDateString("fr-FR");

          document.getElementById("table-body").innerHTML = "";

          const savedDay = localStorage.getItem("planning_" + nouvelleDate);
          if (savedDay && JSON.parse(savedDay).length > 0) {
            JSON.parse(savedDay).forEach(ajouterLigne);
          } else {
            ajouterLigne();
          }

          calculerTousLesTotaux();

          // ‚úÖ AJOUT : Charger les couleurs de cette date
          setTimeout(() => {
            chargerCouleursDate(nouvelleDate);
          }, 100);
        });

        document
          .getElementById("copy-day")
          .addEventListener("click", copierJournee);
        document
          .getElementById("paste-day")
          .addEventListener("click", collerJournee);
        document
          .getElementById("toggle-config-client")
          .addEventListener("click", () => {
            document.getElementById("config-section-client").style.display =
              "block";
          });
        document
          .getElementById("toggle-config-associe")
          .addEventListener("click", () => {
            document.getElementById("config-section-associe").style.display =
              "block";
          });
        document
          .getElementById("toggle-config-chauffeur")
          .addEventListener("click", () => {
            document.getElementById("config-section-chauffeur").style.display =
              "block";
          });
        document
          .getElementById("toggle-config-telephone")
          .addEventListener("click", () => {
            document.getElementById("config-section-telephone").style.display =
              "block";
          });
        document.getElementById("add-row").addEventListener("click", () => {
          ajouterLigne();
          saveCurrentDay();
        });
        document.getElementById("reset-day").addEventListener("click", () => {
          if (confirm("Supprimer toutes les lignes et recommencer ?")) {
            const date = document.getElementById("current-date-picker").value;

            // 1. Supprimer le planning
            localStorage.removeItem("planning_" + date);

            // 2. Supprimer les couleurs de CETTE date uniquement
            const allColors = JSON.parse(
              localStorage.getItem("planningColors") || "{}",
            );
            delete allColors[date];
            localStorage.setItem("planningColors", JSON.stringify(allColors));

            // 3. Nettoyage de l'√©cran
            document.getElementById("table-body").innerHTML = "";
            ajouterLigne();

            afficherNotification("Planning r√©initialis√©", "#dc3545");
          }
        });

        document.getElementById("table-body").addEventListener("input", (e) => {
          const row = e.target.closest("tr");
          if (!row) return;

          // 1. Si c'est un menu d√©roulant (Associe, Client, V√©hicule)
          if (e.target.classList.contains("combo-input")) {
            if (e.target.classList.contains("select-associe")) {
              appliquerCouleurAssocie(e.target);
              // ‚úÖ NE PAS TRIER PENDANT LA SAISIE !
            }
            // Met √† jour le tarif automatiquement selon la config
            updateRowTarif(row);
          }

          // 2. Si c'est du texte √©ditable (Tarif manuel, N¬∞ Bon, etc.)
          if (e.target.isContentEditable) {
            if (e.target.classList.contains("cell-bon")) {
              updateRowHighlight(row);
            }
            // On ne formate pas pendant la saisie, on sauvegarde juste
            saveCurrentDay();
          }
        });

        document
          .getElementById("table-body")
          .addEventListener("change", (e) => {
            if (e.target.classList.contains("select-chauffeur")) {
              // On n'appelle la v√©rification que sur l'√©l√©ment qui vient d'√™tre modifi√©
              verifierDoublon(e.target);
            }
          });

        document.getElementById("table-body").addEventListener(
          "blur",
          function (e) {
            const row = e.target.closest("tr");
            if (!row) return;

            if (
              e.target.classList.contains("cell-tarif") ||
              e.target.classList.contains("cell-tarif-affrete")
            ) {
              updateRowTarif(row); // Formatage et calcul final une fois la saisie termin√©e
              saveCurrentDay();
              return; // On sort pour √©viter de traiter la suite
            }

            if (
              !e.target.classList.contains("cell-supplement-client") &&
              !e.target.classList.contains("cell-supplement-affrete")
            )
              return;

            let value = e.target.textContent
              .replace(/[‚Ç¨\s]/g, "")
              .replace(",", ".");
            const number = parseFloat(value);

            if (!isNaN(number)) {
              e.target.textContent = number.toFixed(2) + " ‚Ç¨";
            } else {
              e.target.textContent = "0.00 ‚Ç¨";
            }

            calculerTotalSupplement_client();
            calculerTotalSupplement_affrete();
            saveCurrentDay();
          },
          true,
        );

        // --- BOUTON CLIENT (Jusqu'√† colonne 14) ---
        document
          .getElementById("copy-image-client")
          .addEventListener("click", function () {
            const table = document.getElementById("my-table");
            const area = document.getElementById("capture-area");
            const tableContainer = document.querySelector(".table-container");
            const marquerBlock =
              document.querySelector(".marquer-container") ||
              document.getElementById("color-picker-tools");

            const endCol = 14;
            const allRows = table.querySelectorAll("tr");

            // 1. SAUVEGARDE ET FORCE LE STYLE "LARGEUR R√âELLE"
            const originalTableStyleWidth = table.style.width;
            const originalContainerMaxHeight = tableContainer.style.maxHeight;
            const originalContainerOverflow = tableContainer.style.overflow;

            const forcedWidth = 1800;
            area.style.width = forcedWidth + "px";
            area.style.minWidth = forcedWidth + "px";

            // Calcul de la largeur n√©cessaire (on peut mettre une valeur fixe large pour √©viter l'√©crasement)
            table.style.width = "100%"; // Force une largeur confortable en pixels
            tableContainer.style.maxHeight = "none";
            tableContainer.style.overflow = "visible";

            if (marquerBlock) marquerBlock.style.visibility = "hidden";

            // Masquage des colonnes non d√©sir√©es
            allRows.forEach((row) => {
              Array.from(row.cells).forEach((cell, index) => {
                if (index > endCol) {
                  cell.style.display = "none";
                }
              });
            });

            html2canvas(area, {
              backgroundColor: "#ffffff",
              scale: 2,
              logging: false,
              useCORS: true,
              width: forcedWidth, // Utilise la largeur calcul√©e avec les 1800px
              windowWidth: forcedWidth,
            }).then((canvas) => {
              canvas.toBlob((blob) => {
                if (blob) {
                  const item = new ClipboardItem({ "image/png": blob });
                  navigator.clipboard.write([item]).then(() => {
                    afficherNotification(
                      "Planning copi√© (Vue Client)",
                      "#2196F3",
                    );
                  });
                }
              });

              // 2. R√âINITIALISATION
              area.style.width = "";
              area.style.minWidth = "";
              table.style.width = originalTableStyleWidth;
              tableContainer.style.maxHeight = originalContainerMaxHeight;
              tableContainer.style.overflow = originalContainerOverflow;
              if (marquerBlock) marquerBlock.style.visibility = "visible";
              allRows.forEach((row) => {
                Array.from(row.cells).forEach((cell) => {
                  cell.style.display = "";
                });
              });
            });
          });

        // --- BOUTON STANDARD (Jusqu'√† colonne 12) ---
        document
          .getElementById("copy-image")
          .addEventListener("click", function () {
            const table = document.getElementById("my-table");
            const area = document.getElementById("capture-area");
            const tableContainer = document.querySelector(".table-container");
            const allRows = table.querySelectorAll("tr");
            const endCol = 12;
            const marquerBlock =
              document.querySelector(".marquer-container") ||
              document.getElementById("color-picker-tools");

            const originalTableStyleWidth = table.style.width;
            const forcedWidth = 1800;
            area.style.width = forcedWidth + "px";
            area.style.minWidth = forcedWidth + "px";

            table.style.width = "100%"; // Largeur fixe pour l'export
            tableContainer.style.maxHeight = "none";
            tableContainer.style.overflow = "visible";

            if (marquerBlock) marquerBlock.style.visibility = "hidden";

            allRows.forEach((row) => {
              Array.from(row.cells).forEach((cell, index) => {
                if (index > endCol) {
                  cell.style.display = "none";
                }
              });
            });

            html2canvas(area, {
              backgroundColor: "#ffffff",
              scale: 2,
              width: forcedWidth,
              windowWidth: forcedWidth,
            }).then((canvas) => {
              canvas.toBlob((blob) => {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]).then(() => {
                  afficherNotification("Planning copi√©", "#2196F3");
                });
              });

              area.style.width = "";
              area.style.minWidth = "";
              table.style.width = originalTableStyleWidth;
              tableContainer.style.maxHeight = "";
              tableContainer.style.overflow = "";
              if (marquerBlock) marquerBlock.style.visibility = "visible";
              allRows.forEach((row) => {
                Array.from(row.cells).forEach((cell) => {
                  cell.style.display = "";
                  cell.style.width = "";
                  cell.style.minWidth = "";
                });
              });
            });
          });

        document
          .getElementById("export-excel")
          .addEventListener("click", function () {
            const datePicker = document.getElementById(
              "current-date-picker",
            ).value;
            if (!datePicker) {
              alert(
                "Veuillez s√©lectionner une date pour d√©finir le mois √† exporter.",
              );
              return;
            }

            const monthPrefix = "planning_" + datePicker.substring(0, 7);
            const workbook = XLSX.utils.book_new();
            const allRows = [];

            const headers = [
              "Associ√©",
              "Matin",
              "A-M",
              "Chantier",
              "Date Chantier",
              "V√©hicule",
              "Client",
              "T√©l√©phone",
              "Consigne",
              "Chauffeur",
              "N¬∞ Commande",
              "N¬∞ Chantier",
              "N¬∞ Bon",
              "Tarif",
              "Supplement Client",
              "IC-client",
              "Tarif Affr√©t√©",
              "Suppl√©ment-Affr√©t√©",
              "IC-affrete",
              "Commentaire",
            ];
            allRows.push(headers);

            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key.startsWith(monthPrefix)) {
                keys.push(key);
              }
            }
            keys.sort();

            let totalClient = 0;
            let totalSupplement_client = 0;
            let IC_client = 0;
            let totalAffrete = 0;
            let totalSupplement_affrete = 0;
            let IC_affrete = 0;

            keys.forEach((key) => {
              const dayData = JSON.parse(localStorage.getItem(key));
              const dateDay = key.replace("planning_", "");

              dayData.forEach((row) => {
                const aUnAssocie = row.associe && row.associe !== "Associ√©...";
                const aUnChantier =
                  row.chantier &&
                  row.chantier !== "Chantier..." &&
                  row.chantier !== "";
                const aUnVehicule =
                  row.vehicule && row.vehicule !== "V√©hicule...";
                const aUnClient = row.client && row.client !== "Client...";
                const aUnTelephone =
                  row.telephone && row.telephone !== "Contact...";
                const aUnChauffeur =
                  row.chauffeur && row.chauffeur !== "Chauffeur...";
                const aUnCommande =
                  row.n_commande &&
                  row.n_commande !== "N¬∞ Commande..." &&
                  row.n_commande !== "";
                const aUnChantierNum =
                  row.n_chantier &&
                  row.n_chantier !== "N¬∞ Chantier..." &&
                  row.n_chantier !== "";
                const aUnBon =
                  row.n_bon && row.n_bon !== "N¬∞ Bon..." && row.n_bon !== "";
                const aUnCommentaire =
                  row.commentaire &&
                  row.commentaire !== "Commentaire..." &&
                  row.commentaire !== "";

                if (
                  !aUnAssocie &&
                  !aUnChantier &&
                  !aUnVehicule &&
                  !aUnClient &&
                  !aUnTelephone &&
                  !aUnChauffeur &&
                  !aUnCommande &&
                  !aUnChantierNum &&
                  !aUnBon &&
                  !aUnCommentaire
                ) {
                  return; // On passe √† la ligne suivante sans l'ajouter √† Excel
                }
                const tarif = parseFloat(
                  (row.tarif || "0").replace(/[‚Ç¨\s]/g, "").replace(",", "."),
                );
                const suppClient = parseFloat(
                  (row.supplement_client || "0")
                    .replace(/[‚Ç¨\s]/g, "")
                    .replace(",", "."),
                );
                const ICClient = parseFloat(
                  (row.IC_client || "0")
                    .replace(/[‚Ç¨\s]/g, "")
                    .replace(",", "."),
                );
                const tarifAff = parseFloat(
                  (row.tarif_affrete || "0")
                    .replace(/[‚Ç¨\s]/g, "")
                    .replace(",", "."),
                );
                const suppAff = parseFloat(
                  (row.supplement_affrete || "0")
                    .replace(/[‚Ç¨\s]/g, "")
                    .replace(",", "."),
                );
                const ICAffrete = parseFloat(
                  (row.IC_affrete || "0")
                    .replace(/[‚Ç¨\s]/g, "")
                    .replace(",", "."),
                );

                if (!isNaN(tarif)) totalClient += tarif;
                if (!isNaN(suppClient)) totalSupplement_client += suppClient;
                if (!isNaN(ICClient)) IC_client += ICClient;
                if (!isNaN(tarifAff)) totalAffrete += tarifAff;
                if (!isNaN(suppAff)) totalSupplement_affrete += suppAff;
                if (!isNaN(ICAffrete)) IC_affrete += ICAffrete;

                const clean = (val, def) => {
                  if (!val || val === def || val.trim() === "") return "";
                  return val;
                };

                const rowData = [
                  clean(row.associe, "Associ√©..."),
                  row.matin, // On garde 0.5 car c'est un chiffre utile au calcul
                  row.apres, // Idem
                  clean(row.chantier, "Chantier..."),
                  row.date,
                  clean(row.vehicule, "V√©hicule..."),
                  clean(row.client, "Client..."),
                  clean(row.telephone, "Contact..."),
                  clean(row.consigne, "Consigne..."),
                  clean(row.chauffeur, "Chauffeur..."),
                  clean(row.n_commande, "N¬∞ Commande..."),
                  clean(row.n_chantier, "N¬∞ Chantier..."),
                  clean(row.n_bon, "N¬∞ Bon..."),
                  tarif || 0,
                  suppClient || 0,
                  ICClient || 0,
                  tarifAff || 0,
                  suppAff || 0,
                  ICAffrete || 0,
                  clean(row.commentaire, "Commentaire..."),
                ];

                allRows.push(rowData);
              });
            });

            if (allRows.length <= 1) {
              alert("Aucune donn√©e enregistr√©e pour ce mois.");
              return;
            }

            allRows.push([]);
            allRows.push([
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "TOTAL MOIS :",
              totalClient.toFixed(2) + " ‚Ç¨",
              totalSupplement_client.toFixed(2) + " ‚Ç¨",
              IC_client.toFixed(2) + " ‚Ç¨",
              totalAffrete.toFixed(2) + " ‚Ç¨",
              totalSupplement_affrete.toFixed(2) + " ‚Ç¨",
              IC_affrete.toFixed(2) + " ‚Ç¨",
              "",
            ]);

            const worksheet = XLSX.utils.aoa_to_sheet(allRows);
            const moneyCols = [13, 14, 15, 16, 17, 18];

            for (let R = 1; R < allRows.length; R++) {
              moneyCols.forEach((C) => {
                const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                if (
                  worksheet[cellRef] &&
                  typeof worksheet[cellRef].v === "number"
                ) {
                  worksheet[cellRef].t = "n";
                  worksheet[cellRef].z = "0.00";
                }
              });
            }

            XLSX.utils.book_append_sheet(workbook, worksheet, "Export Mensuel");

            XLSX.writeFile(
              workbook,
              `Transport_${datePicker.substring(0, 7)}.xlsx`,
            );
          });
      });
      window.addEventListener("load", () => {
        const currentDate = document.getElementById(
          "current-date-picker",
        ).value;
        chargerCouleursDate(currentDate);
      });
      // --- FONCTIONS DE SAUVEGARDE ET RESTAURATION ---

      function sauvegarderConfigComplete() {
        const backup = {};
        // On boucle sur TOUT ce qui est stock√© dans le navigateur
        for (let i = 0; i < localStorage.length; i++) {
          const cle = localStorage.key(i);
          backup[cle] = localStorage.getItem(cle);
        }

        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(backup));
        const downloadAnchorNode = document.createElement("a");
        const date = new Date().toLocaleDateString("fr-FR").replace(/\//g, "-");

        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute(
          "download",
          "SAUVEGARDE_TOTALE_" + date + ".json",
        );
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }

      function restaurerConfigComplete(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const backup = JSON.parse(e.target.result);
            if (
              confirm(
                "Voulez-vous restaurer l'int√©gralit√© des donn√©es (Planning + Tarifs) ?",
              )
            ) {
              // On vide TOUT avant de restaurer
              localStorage.clear();

              // On remet chaque √©l√©ment sauvegard√©
              Object.keys(backup).forEach((cle) => {
                localStorage.setItem(cle, backup[cle]);
              });

              alert("‚úÖ Tout a √©t√© restaur√© avec succ√®s !");
              window.location.reload();
            }
          } catch (err) {
            alert("‚ùå Erreur de fichier.");
          }
        };
        reader.readAsText(file);
        input.value = "";
      }
    </script>

    <div
      id="help-modal"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
      "
    >
      <h3 style="margin-top: 0">üí° Aide & Raccourcis</h3>
      <ul style="margin-top: 0; padding-left: 20px">
        <li style="margin-bottom: 2px">
          <i>Cliquez dans les cases blanches pour saisir vos informations.</i>
        </li>

        <li style="margin-bottom: 2px">
          <i
            >S√©lectionnez la date dans le calendrier
            <input type="date" class="fake-date" /> pour changer de jour.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i>S√©lectionnez plusieurs cases pour copier leur contenu.</i>
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #28a745; font-weight: bold">VERT</span> pour
            rajouter une ligne.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #dc3545; font-weight: bold">ROUGE</span> pour
            tout supprimer la journ√©e.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #ff00b7; font-weight: bold">ROSE</span>
            pour copier la journ√©e actuelle.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #00d69a; font-weight: bold">TURQUOISE</span>
            pour coller la journ√©e copi√©e.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #6610f2; font-weight: bold">BLEU</span> pour
            copier le planning entier en image.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #07cc00; font-weight: bold">VERT CLAIR</span>
            pour copier le planning jusqu'√† la colonne "Suppl√©ment-client".</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #ff9500; font-weight: bold">ORANGE</span> pour
            exporter le planning du mois en fichier Excel.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #6c757d; font-weight: bold">GRIS</span> pour
            configurer les prix des clients.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #17a2b8; font-weight: bold">BLEU CLAIR</span>
            pour configurer les prix des associ√©s.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur le bouton
            <span style="color: #9b1594; font-weight: bold">VIOLET</span> pour
            configurer la liste des chauffeurs.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur les cases de filtres pour rechercher un associ√© ou un
            client.
          </i>
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur la feuille √† droite üìë pour duppliquer une seule
            ligne.</i
          >
        </li>

        <li style="margin-bottom: 2px">
          <i
            >Appuyez sur la corbeille √† droite üóëÔ∏è pour supprimer une seule
            ligne.</i
          >
        </li>
      </ul>
      <button
        onclick="toggleHelp()"
        style="
          width: 100%;
          padding: 10px;
          cursor: pointer;
          background: #eee;
          border: 1px solid #ccc;
          border-radius: 4px;
        "
      >
        Fermer
      </button>
    </div>

    <div
      id="help-overlay"
      onclick="toggleHelp()"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      "
    ></div>

    <div class="admin-footer-actions">
      <div class="footer-left-group">
        <button onclick="resetTout()" class="btn-maintenance">
          Don't touch me !
        </button>

        <button
          onclick="reparerDonneesManuellement()"
          class="btn-maintenance btn-repair"
        >
          üîß R√©parer les donn√©es
        </button>

        <button
          onclick="sauvegarderConfigComplete()"
          class="btn-maintenance"
          style="
            background-color: #28a745;
            color: white;
            opacity: 1;
            border: none;
          "
        >
          üíæ Sauvegarder Config
        </button>

        <button
          onclick="document.getElementById('input-restaurer').click()"
          class="btn-maintenance"
          style="
            background-color: #ffc107;
            color: black;
            opacity: 1;
            border: none;
          "
        >
          üìÇ Restaurer Config
        </button>
        <input
          type="file"
          id="input-restaurer"
          style="display: none"
          onchange="restaurerConfigComplete(this)"
        />
      </div>

      <button
        onclick="toggleHelp()"
        class="btn-help-circle"
        title="Aide et Astuces"
      >
        ?
      </button>
    </div>
  </body>
</html>
